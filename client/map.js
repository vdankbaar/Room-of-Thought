"use strict";(()=>{var kn=Object.defineProperty;var xn=(e,t)=>{for(var n in t)kn(e,n,{get:t[n],enumerable:!0})};var J=Object.create(null);J.open="0";J.close="1";J.ping="2";J.pong="3";J.message="4";J.upgrade="5";J.noop="6";var Ce=Object.create(null);Object.keys(J).forEach(e=>{Ce[J[e]]=e});var Pe={type:"error",data:"parser error"};var St=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",It=typeof ArrayBuffer=="function",Lt=e=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,Ne=({type:e,data:t},n,o)=>St&&t instanceof Blob?n?o(t):Mt(t,o):It&&(t instanceof ArrayBuffer||Lt(t))?n?o(t):Mt(new Blob([t]),o):o(J[e]+(t||"")),Mt=(e,t)=>{let n=new FileReader;return n.onload=function(){let o=n.result.split(",")[1];t("b"+(o||""))},n.readAsDataURL(e)};function Et(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}var st;function Bt(e,t){if(St&&e.data instanceof Blob)return e.data.arrayBuffer().then(Et).then(t);if(It&&(e.data instanceof ArrayBuffer||Lt(e.data)))return t(Et(e.data));Ne(e,!1,n=>{st||(st=new TextEncoder),t(st.encode(n))})}var Dt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ae=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let e=0;e<Dt.length;e++)Ae[Dt.charCodeAt(e)]=e;var Ct=e=>{let t=e.length*.75,n=e.length,o,r=0,a,u,m,g;e[e.length-1]==="="&&(t--,e[e.length-2]==="="&&t--);let h=new ArrayBuffer(t),w=new Uint8Array(h);for(o=0;o<n;o+=4)a=Ae[e.charCodeAt(o)],u=Ae[e.charCodeAt(o+1)],m=Ae[e.charCodeAt(o+2)],g=Ae[e.charCodeAt(o+3)],w[r++]=a<<2|u>>4,w[r++]=(u&15)<<4|m>>2,w[r++]=(m&3)<<6|g&63;return h};var wn=typeof ArrayBuffer=="function",He=(e,t)=>{if(typeof e!="string")return{type:"message",data:Pt(e,t)};let n=e.charAt(0);return n==="b"?{type:"message",data:Tn(e.substring(1),t)}:Ce[n]?e.length>1?{type:Ce[n],data:e.substring(1)}:{type:Ce[n]}:Pe},Tn=(e,t)=>{if(wn){let n=Ct(e);return Pt(n,t)}else return{base64:!0,data:e}},Pt=(e,t)=>{switch(t){case"blob":return e instanceof Blob?e:new Blob([e]);case"arraybuffer":default:return e instanceof ArrayBuffer?e:e.buffer}};var Nt=String.fromCharCode(30),At=(e,t)=>{let n=e.length,o=new Array(n),r=0;e.forEach((a,u)=>{Ne(a,!1,m=>{o[u]=m,++r===n&&t(o.join(Nt))})})},Ht=(e,t)=>{let n=e.split(Nt),o=[];for(let r=0;r<n.length;r++){let a=He(n[r],t);if(o.push(a),a.type==="error")break}return o};function zt(){return new TransformStream({transform(e,t){Bt(e,n=>{let o=n.length,r;if(o<126)r=new Uint8Array(1),new DataView(r.buffer).setUint8(0,o);else if(o<65536){r=new Uint8Array(3);let a=new DataView(r.buffer);a.setUint8(0,126),a.setUint16(1,o)}else{r=new Uint8Array(9);let a=new DataView(r.buffer);a.setUint8(0,127),a.setBigUint64(1,BigInt(o))}e.data&&typeof e.data!="string"&&(r[0]|=128),t.enqueue(r),t.enqueue(n)})}})}var at;function Fe(e){return e.reduce((t,n)=>t+n.length,0)}function Ve(e,t){if(e[0].length===t)return e.shift();let n=new Uint8Array(t),o=0;for(let r=0;r<t;r++)n[r]=e[0][o++],o===e[0].length&&(e.shift(),o=0);return e.length&&o<e[0].length&&(e[0]=e[0].slice(o)),n}function Ot(e,t){at||(at=new TextDecoder);let n=[],o=0,r=-1,a=!1;return new TransformStream({transform(u,m){for(n.push(u);;){if(o===0){if(Fe(n)<1)break;let g=Ve(n,1);a=(g[0]&128)===128,r=g[0]&127,r<126?o=3:r===126?o=1:o=2}else if(o===1){if(Fe(n)<2)break;let g=Ve(n,2);r=new DataView(g.buffer,g.byteOffset,g.length).getUint16(0),o=3}else if(o===2){if(Fe(n)<8)break;let g=Ve(n,8),h=new DataView(g.buffer,g.byteOffset,g.length),w=h.getUint32(0);if(w>Math.pow(2,53-32)-1){m.enqueue(Pe);break}r=w*Math.pow(2,32)+h.getUint32(4),o=3}else{if(Fe(n)<r)break;let g=Ve(n,r);m.enqueue(He(a?g:at.decode(g),t)),o=0}if(r===0||r>e){m.enqueue(Pe);break}}}})}var lt=4;function E(e){if(e)return Mn(e)}function Mn(e){for(var t in E.prototype)e[t]=E.prototype[t];return e}E.prototype.on=E.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this};E.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this};E.prototype.off=E.prototype.removeListener=E.prototype.removeAllListeners=E.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var n=this._callbacks["$"+e];if(!n)return this;if(arguments.length==1)return delete this._callbacks["$"+e],this;for(var o,r=0;r<n.length;r++)if(o=n[r],o===t||o.fn===t){n.splice(r,1);break}return n.length===0&&delete this._callbacks["$"+e],this};E.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],o=1;o<arguments.length;o++)t[o-1]=arguments[o];if(n){n=n.slice(0);for(var o=0,r=n.length;o<r;++o)n[o].apply(this,t)}return this};E.prototype.emitReserved=E.prototype.emit;E.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]};E.prototype.hasListeners=function(e){return!!this.listeners(e).length};var H=(()=>typeof self<"u"?self:typeof window<"u"?window:Function("return this")())();function Ke(e,...t){return t.reduce((n,o)=>(e.hasOwnProperty(o)&&(n[o]=e[o]),n),{})}var En=H.setTimeout,Sn=H.clearTimeout;function ie(e,t){t.useNativeTimers?(e.setTimeoutFn=En.bind(H),e.clearTimeoutFn=Sn.bind(H)):(e.setTimeoutFn=H.setTimeout.bind(H),e.clearTimeoutFn=H.clearTimeout.bind(H))}var In=1.33;function Rt(e){return typeof e=="string"?Ln(e):Math.ceil((e.byteLength||e.size)*In)}function Ln(e){let t=0,n=0;for(let o=0,r=e.length;o<r;o++)t=e.charCodeAt(o),t<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(o++,n+=4);return n}function _t(e){let t="";for(let n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}function $t(e){let t={},n=e.split("&");for(let o=0,r=n.length;o<r;o++){let a=n[o].split("=");t[decodeURIComponent(a[0])]=decodeURIComponent(a[1])}return t}var ct=class extends Error{constructor(t,n,o){super(t),this.description=n,this.context=o,this.type="TransportError"}},oe=class extends E{constructor(t){super(),this.writable=!1,ie(this,t),this.opts=t,this.query=t.query,this.socket=t.socket}onError(t,n,o){return super.emitReserved("error",new ct(t,n,o)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(t){this.readyState==="open"&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){let n=He(t,this.socket.binaryType);this.onPacket(n)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,n={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(n)}_hostname(){let t=this.opts.hostname;return t.indexOf(":")===-1?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(t){let n=_t(t);return n.length?"?"+n:""}};var Ft="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),ut=64,Bn={},Yt=0,We=0,Xt;function qt(e){let t="";do t=Ft[e%ut]+t,e=Math.floor(e/ut);while(e>0);return t}function Ue(){let e=qt(+new Date);return e!==Xt?(Yt=0,Xt=e):e+"."+qt(Yt++)}for(;We<ut;We++)Bn[Ft[We]]=We;var Vt=!1;try{Vt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}var Kt=Vt;function dt(e){let t=e.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!t||Kt))return new XMLHttpRequest}catch{}if(!t)try{return new H[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}function Dn(){}var Cn=function(){return new dt({xdomain:!1}).responseType!=null}(),Ge=class extends oe{constructor(t){if(super(t),this.polling=!1,typeof location<"u"){let o=location.protocol==="https:",r=location.port;r||(r=o?"443":"80"),this.xd=typeof location<"u"&&t.hostname!==location.hostname||r!==t.port}let n=t&&t.forceBase64;this.supportsBinary=Cn&&!n,this.opts.withCredentials&&(this.cookieJar=void 0)}get name(){return"polling"}doOpen(){this.poll()}pause(t){this.readyState="pausing";let n=()=>{this.readyState="paused",t()};if(this.polling||!this.writable){let o=0;this.polling&&(o++,this.once("pollComplete",function(){--o||n()})),this.writable||(o++,this.once("drain",function(){--o||n()}))}else n()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){let n=o=>{if(this.readyState==="opening"&&o.type==="open"&&this.onOpen(),o.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(o)};Ht(t,this.socket.binaryType).forEach(n),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){let t=()=>{this.write([{type:"close"}])};this.readyState==="open"?t():this.once("open",t)}write(t){this.writable=!1,At(t,n=>{this.doWrite(n,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){let t=this.opts.secure?"https":"http",n=this.query||{};return this.opts.timestampRequests!==!1&&(n[this.opts.timestampParam]=Ue()),!this.supportsBinary&&!n.sid&&(n.b64=1),this.createUri(t,n)}request(t={}){return Object.assign(t,{xd:this.xd,cookieJar:this.cookieJar},this.opts),new le(this.uri(),t)}doWrite(t,n){let o=this.request({method:"POST",data:t});o.on("success",n),o.on("error",(r,a)=>{this.onError("xhr post error",r,a)})}doPoll(){let t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(n,o)=>{this.onError("xhr poll error",n,o)}),this.pollXhr=t}},le=class e extends E{constructor(t,n){super(),ie(this,n),this.opts=n,this.method=n.method||"GET",this.uri=t,this.data=n.data!==void 0?n.data:null,this.create()}create(){var t;let n=Ke(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");n.xdomain=!!this.opts.xd;let o=this.xhr=new dt(n);try{o.open(this.method,this.uri,!0);try{if(this.opts.extraHeaders){o.setDisableHeaderCheck&&o.setDisableHeaderCheck(!0);for(let r in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(r)&&o.setRequestHeader(r,this.opts.extraHeaders[r])}}catch{}if(this.method==="POST")try{o.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{o.setRequestHeader("Accept","*/*")}catch{}(t=this.opts.cookieJar)===null||t===void 0||t.addCookies(o),"withCredentials"in o&&(o.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(o.timeout=this.opts.requestTimeout),o.onreadystatechange=()=>{var r;o.readyState===3&&((r=this.opts.cookieJar)===null||r===void 0||r.parseCookies(o)),o.readyState===4&&(o.status===200||o.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof o.status=="number"?o.status:0)},0))},o.send(this.data)}catch(r){this.setTimeoutFn(()=>{this.onError(r)},0);return}typeof document<"u"&&(this.index=e.requestsCount++,e.requests[this.index]=this)}onError(t){this.emitReserved("error",t,this.xhr),this.cleanup(!0)}cleanup(t){if(!(typeof this.xhr>"u"||this.xhr===null)){if(this.xhr.onreadystatechange=Dn,t)try{this.xhr.abort()}catch{}typeof document<"u"&&delete e.requests[this.index],this.xhr=null}}onLoad(){let t=this.xhr.responseText;t!==null&&(this.emitReserved("data",t),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}};le.requestsCount=0;le.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Wt);else if(typeof addEventListener=="function"){let e="onpagehide"in H?"pagehide":"unload";addEventListener(e,Wt,!1)}}function Wt(){for(let e in le.requests)le.requests.hasOwnProperty(e)&&le.requests[e].abort()}var ge=(()=>typeof Promise=="function"&&typeof Promise.resolve=="function"?t=>Promise.resolve().then(t):(t,n)=>n(t,0))(),ze=H.WebSocket||H.MozWebSocket,Je=!0,Ut="arraybuffer";var Gt=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative",je=class extends oe{constructor(t){super(t),this.supportsBinary=!t.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;let t=this.uri(),n=this.opts.protocols,o=Gt?{}:Ke(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(o.headers=this.opts.extraHeaders);try{this.ws=Je&&!Gt?n?new ze(t,n):new ze(t):new ze(t,n,o)}catch(r){return this.emitReserved("error",r)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let n=0;n<t.length;n++){let o=t[n],r=n===t.length-1;Ne(o,this.supportsBinary,a=>{let u={};Je||(o.options&&(u.compress=o.options.compress),this.opts.perMessageDeflate&&(typeof a=="string"?Buffer.byteLength(a):a.length)<this.opts.perMessageDeflate.threshold&&(u.compress=!1));try{Je?this.ws.send(a):this.ws.send(a,u)}catch{}r&&ge(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.close(),this.ws=null)}uri(){let t=this.opts.secure?"wss":"ws",n=this.query||{};return this.opts.timestampRequests&&(n[this.opts.timestampParam]=Ue()),this.supportsBinary||(n.b64=1),this.createUri(t,n)}check(){return!!ze}};var Qe=class extends oe{get name(){return"webtransport"}doOpen(){typeof WebTransport=="function"&&(this.transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name]),this.transport.closed.then(()=>{this.onClose()}).catch(t=>{this.onError("webtransport error",t)}),this.transport.ready.then(()=>{this.transport.createBidirectionalStream().then(t=>{let n=Ot(Number.MAX_SAFE_INTEGER,this.socket.binaryType),o=t.readable.pipeThrough(n).getReader(),r=zt();r.readable.pipeTo(t.writable),this.writer=r.writable.getWriter();let a=()=>{o.read().then(({done:m,value:g})=>{m||(this.onPacket(g),a())}).catch(m=>{})};a();let u={type:"open"};this.query.sid&&(u.data=`{"sid":"${this.query.sid}"}`),this.writer.write(u).then(()=>this.onOpen())})}))}write(t){this.writable=!1;for(let n=0;n<t.length;n++){let o=t[n],r=n===t.length-1;this.writer.write(o).then(()=>{r&&ge(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var t;(t=this.transport)===null||t===void 0||t.close()}};var pt={websocket:je,webtransport:Qe,polling:Ge};var Pn=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Nn=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Me(e){let t=e,n=e.indexOf("["),o=e.indexOf("]");n!=-1&&o!=-1&&(e=e.substring(0,n)+e.substring(n,o).replace(/:/g,";")+e.substring(o,e.length));let r=Pn.exec(e||""),a={},u=14;for(;u--;)a[Nn[u]]=r[u]||"";return n!=-1&&o!=-1&&(a.source=t,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a.pathNames=An(a,a.path),a.queryKey=Hn(a,a.query),a}function An(e,t){let n=/\/{2,9}/g,o=t.replace(n,"/").split("/");return(t.slice(0,1)=="/"||t.length===0)&&o.splice(0,1),t.slice(-1)=="/"&&o.splice(o.length-1,1),o}function Hn(e,t){let n={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(o,r,a){r&&(n[r]=a)}),n}var ye=class e extends E{constructor(t,n={}){super(),this.binaryType=Ut,this.writeBuffer=[],t&&typeof t=="object"&&(n=t,t=null),t?(t=Me(t),n.hostname=t.host,n.secure=t.protocol==="https"||t.protocol==="wss",n.port=t.port,t.query&&(n.query=t.query)):n.host&&(n.hostname=Me(n.host).host),ie(this,n),this.secure=n.secure!=null?n.secure:typeof location<"u"&&location.protocol==="https:",n.hostname&&!n.port&&(n.port=this.secure?"443":"80"),this.hostname=n.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=n.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=n.transports||["polling","websocket","webtransport"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},n),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=$t(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(t){let n=Object.assign({},this.opts.query);n.EIO=lt,n.transport=t,this.id&&(n.sid=this.id);let o=Object.assign({},this.opts,{query:n,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new pt[t](o)}open(){let t;if(this.opts.rememberUpgrade&&e.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)t="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else t=this.transports[0];this.readyState="opening";try{t=this.createTransport(t)}catch{this.transports.shift(),this.open();return}t.open(),this.setTransport(t)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",n=>this.onClose("transport close",n))}probe(t){let n=this.createTransport(t),o=!1;e.priorWebsocketSuccess=!1;let r=()=>{o||(n.send([{type:"ping",data:"probe"}]),n.once("packet",v=>{if(!o)if(v.type==="pong"&&v.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",n),!n)return;e.priorWebsocketSuccess=n.name==="websocket",this.transport.pause(()=>{o||this.readyState!=="closed"&&(w(),this.setTransport(n),n.send([{type:"upgrade"}]),this.emitReserved("upgrade",n),n=null,this.upgrading=!1,this.flush())})}else{let M=new Error("probe error");M.transport=n.name,this.emitReserved("upgradeError",M)}}))};function a(){o||(o=!0,w(),n.close(),n=null)}let u=v=>{let M=new Error("probe error: "+v);M.transport=n.name,a(),this.emitReserved("upgradeError",M)};function m(){u("transport closed")}function g(){u("socket closed")}function h(v){n&&v.name!==n.name&&a()}let w=()=>{n.removeListener("open",r),n.removeListener("error",u),n.removeListener("close",m),this.off("close",g),this.off("upgrading",h)};n.once("open",r),n.once("error",u),n.once("close",m),this.once("close",g),this.once("upgrading",h),this.upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"?this.setTimeoutFn(()=>{o||n.open()},200):n.open()}onOpen(){if(this.readyState="open",e.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let t=0,n=this.upgrades.length;for(;t<n;t++)this.probe(this.upgrades[t])}}onPacket(t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),this.resetPingTimeout(),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":let n=new Error("server error");n.code=t.data,this.onError(n);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data);break}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this.upgrades=this.filterUpgrades(t.upgrades),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout,this.maxPayload=t.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){let t=this.getWritablePackets();this.transport.send(t),this.prevBufferLen=t.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let n=1;for(let o=0;o<this.writeBuffer.length;o++){let r=this.writeBuffer[o].data;if(r&&(n+=Rt(r)),o>0&&n>this.maxPayload)return this.writeBuffer.slice(0,o);n+=2}return this.writeBuffer}write(t,n,o){return this.sendPacket("message",t,n,o),this}send(t,n,o){return this.sendPacket("message",t,n,o),this}sendPacket(t,n,o,r){if(typeof n=="function"&&(r=n,n=void 0),typeof o=="function"&&(r=o,o=null),this.readyState==="closing"||this.readyState==="closed")return;o=o||{},o.compress=o.compress!==!1;let a={type:t,data:n,options:o};this.emitReserved("packetCreate",a),this.writeBuffer.push(a),r&&this.once("flush",r),this.flush()}close(){let t=()=>{this.onClose("forced close"),this.transport.close()},n=()=>{this.off("upgrade",n),this.off("upgradeError",n),t()},o=()=>{this.once("upgrade",n),this.once("upgradeError",n)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?o():t()}):this.upgrading?o():t()),this}onError(t){e.priorWebsocketSuccess=!1,this.emitReserved("error",t),this.onClose("transport error",t)}onClose(t,n){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",t,n),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(t){let n=[],o=0,r=t.length;for(;o<r;o++)~this.transports.indexOf(t[o])&&n.push(t[o]);return n}};ye.protocol=lt;var vo=ye.protocol;function Jt(e,t="",n){let o=e;n=n||typeof location<"u"&&location,e==null&&(e=n.protocol+"//"+n.host),typeof e=="string"&&(e.charAt(0)==="/"&&(e.charAt(1)==="/"?e=n.protocol+e:e=n.host+e),/^(https?|wss?):\/\//.test(e)||(typeof n<"u"?e=n.protocol+"//"+e:e="https://"+e),o=Me(e)),o.port||(/^(http|ws)$/.test(o.protocol)?o.port="80":/^(http|ws)s$/.test(o.protocol)&&(o.port="443")),o.path=o.path||"/";let a=o.host.indexOf(":")!==-1?"["+o.host+"]":o.host;return o.id=o.protocol+"://"+a+":"+o.port+t,o.href=o.protocol+"://"+a+(n&&n.port===o.port?"":":"+o.port),o}var vt={};xn(vt,{Decoder:()=>gt,Encoder:()=>mt,PacketType:()=>T,protocol:()=>tn});var zn=typeof ArrayBuffer=="function",On=e=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer,jt=Object.prototype.toString,Rn=typeof Blob=="function"||typeof Blob<"u"&&jt.call(Blob)==="[object BlobConstructor]",_n=typeof File=="function"||typeof File<"u"&&jt.call(File)==="[object FileConstructor]";function Re(e){return zn&&(e instanceof ArrayBuffer||On(e))||Rn&&e instanceof Blob||_n&&e instanceof File}function Oe(e,t){if(!e||typeof e!="object")return!1;if(Array.isArray(e)){for(let n=0,o=e.length;n<o;n++)if(Oe(e[n]))return!0;return!1}if(Re(e))return!0;if(e.toJSON&&typeof e.toJSON=="function"&&arguments.length===1)return Oe(e.toJSON(),!0);for(let n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&Oe(e[n]))return!0;return!1}function Qt(e){let t=[],n=e.data,o=e;return o.data=ft(n,t),o.attachments=t.length,{packet:o,buffers:t}}function ft(e,t){if(!e)return e;if(Re(e)){let n={_placeholder:!0,num:t.length};return t.push(e),n}else if(Array.isArray(e)){let n=new Array(e.length);for(let o=0;o<e.length;o++)n[o]=ft(e[o],t);return n}else if(typeof e=="object"&&!(e instanceof Date)){let n={};for(let o in e)Object.prototype.hasOwnProperty.call(e,o)&&(n[o]=ft(e[o],t));return n}return e}function Zt(e,t){return e.data=ht(e.data,t),delete e.attachments,e}function ht(e,t){if(!e)return e;if(e&&e._placeholder===!0){if(typeof e.num=="number"&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}else if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=ht(e[n],t);else if(typeof e=="object")for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=ht(e[n],t));return e}var $n=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],tn=5,T;(function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"})(T||(T={}));var mt=class{constructor(t){this.replacer=t}encode(t){return(t.type===T.EVENT||t.type===T.ACK)&&Oe(t)?this.encodeAsBinary({type:t.type===T.EVENT?T.BINARY_EVENT:T.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id}):[this.encodeAsString(t)]}encodeAsString(t){let n=""+t.type;return(t.type===T.BINARY_EVENT||t.type===T.BINARY_ACK)&&(n+=t.attachments+"-"),t.nsp&&t.nsp!=="/"&&(n+=t.nsp+","),t.id!=null&&(n+=t.id),t.data!=null&&(n+=JSON.stringify(t.data,this.replacer)),n}encodeAsBinary(t){let n=Qt(t),o=this.encodeAsString(n.packet),r=n.buffers;return r.unshift(o),r}};function en(e){return Object.prototype.toString.call(e)==="[object Object]"}var gt=class e extends E{constructor(t){super(),this.reviver=t}add(t){let n;if(typeof t=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");n=this.decodeString(t);let o=n.type===T.BINARY_EVENT;o||n.type===T.BINARY_ACK?(n.type=o?T.EVENT:T.ACK,this.reconstructor=new yt(n),n.attachments===0&&super.emitReserved("decoded",n)):super.emitReserved("decoded",n)}else if(Re(t)||t.base64)if(this.reconstructor)n=this.reconstructor.takeBinaryData(t),n&&(this.reconstructor=null,super.emitReserved("decoded",n));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+t)}decodeString(t){let n=0,o={type:Number(t.charAt(0))};if(T[o.type]===void 0)throw new Error("unknown packet type "+o.type);if(o.type===T.BINARY_EVENT||o.type===T.BINARY_ACK){let a=n+1;for(;t.charAt(++n)!=="-"&&n!=t.length;);let u=t.substring(a,n);if(u!=Number(u)||t.charAt(n)!=="-")throw new Error("Illegal attachments");o.attachments=Number(u)}if(t.charAt(n+1)==="/"){let a=n+1;for(;++n&&!(t.charAt(n)===","||n===t.length););o.nsp=t.substring(a,n)}else o.nsp="/";let r=t.charAt(n+1);if(r!==""&&Number(r)==r){let a=n+1;for(;++n;){let u=t.charAt(n);if(u==null||Number(u)!=u){--n;break}if(n===t.length)break}o.id=Number(t.substring(a,n+1))}if(t.charAt(++n)){let a=this.tryParse(t.substr(n));if(e.isPayloadValid(o.type,a))o.data=a;else throw new Error("invalid payload")}return o}tryParse(t){try{return JSON.parse(t,this.reviver)}catch{return!1}}static isPayloadValid(t,n){switch(t){case T.CONNECT:return en(n);case T.DISCONNECT:return n===void 0;case T.CONNECT_ERROR:return typeof n=="string"||en(n);case T.EVENT:case T.BINARY_EVENT:return Array.isArray(n)&&(typeof n[0]=="number"||typeof n[0]=="string"&&$n.indexOf(n[0])===-1);case T.ACK:case T.BINARY_ACK:return Array.isArray(n)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}},yt=class{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){let n=Zt(this.reconPack,this.buffers);return this.finishedReconstruction(),n}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}};function F(e,t,n){return e.on(t,n),function(){e.off(t,n)}}var Yn=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1}),Ee=class extends E{constructor(t,n,o){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=n,o&&o.auth&&(this.auth=o.auth),this._opts=Object.assign({},o),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;let t=this.io;this.subs=[F(t,"open",this.onopen.bind(this)),F(t,"packet",this.onpacket.bind(this)),F(t,"error",this.onerror.bind(this)),F(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...n){if(Yn.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(n.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(n),this;let o={type:T.EVENT,data:n};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof n[n.length-1]=="function"){let u=this.ids++,m=n.pop();this._registerAckCallback(u,m),o.id=u}let r=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!r||!this.connected)||(this.connected?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(t,n){var o;let r=(o=this.flags.timeout)!==null&&o!==void 0?o:this._opts.ackTimeout;if(r===void 0){this.acks[t]=n;return}let a=this.io.setTimeoutFn(()=>{delete this.acks[t];for(let u=0;u<this.sendBuffer.length;u++)this.sendBuffer[u].id===t&&this.sendBuffer.splice(u,1);n.call(this,new Error("operation has timed out"))},r);this.acks[t]=(...u)=>{this.io.clearTimeoutFn(a),n.apply(this,[null,...u])}}emitWithAck(t,...n){let o=this.flags.timeout!==void 0||this._opts.ackTimeout!==void 0;return new Promise((r,a)=>{n.push((u,m)=>o?u?a(u):r(m):r(u)),this.emit(t,...n)})}_addToQueue(t){let n;typeof t[t.length-1]=="function"&&(n=t.pop());let o={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push((r,...a)=>o!==this._queue[0]?void 0:(r!==null?o.tryCount>this._opts.retries&&(this._queue.shift(),n&&n(r)):(this._queue.shift(),n&&n(null,...a)),o.pending=!1,this._drainQueue())),this._queue.push(o),this._drainQueue()}_drainQueue(t=!1){if(!this.connected||this._queue.length===0)return;let n=this._queue[0];n.pending&&!t||(n.pending=!0,n.tryCount++,this.flags=n.flags,this.emit.apply(this,n.args))}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){typeof this.auth=="function"?this.auth(t=>{this._sendConnectPacket(t)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:T.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,n){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,n)}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case T.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case T.EVENT:case T.BINARY_EVENT:this.onevent(t);break;case T.ACK:case T.BINARY_ACK:this.onack(t);break;case T.DISCONNECT:this.ondisconnect();break;case T.CONNECT_ERROR:this.destroy();let o=new Error(t.data.message);o.data=t.data.data,this.emitReserved("connect_error",o);break}}onevent(t){let n=t.data||[];t.id!=null&&n.push(this.ack(t.id)),this.connected?this.emitEvent(n):this.receiveBuffer.push(Object.freeze(n))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){let n=this._anyListeners.slice();for(let o of n)o.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&typeof t[t.length-1]=="string"&&(this._lastOffset=t[t.length-1])}ack(t){let n=this,o=!1;return function(...r){o||(o=!0,n.packet({type:T.ACK,id:t,data:r}))}}onack(t){let n=this.acks[t.id];typeof n=="function"&&(n.apply(this,t.data),delete this.acks[t.id])}onconnect(t,n){this.id=t,this.recovered=n&&this._pid===n,this._pid=n,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(t=>this.emitEvent(t)),this.receiveBuffer=[],this.sendBuffer.forEach(t=>{this.notifyOutgoingListeners(t),this.packet(t)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(t=>t()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:T.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){let n=this._anyListeners;for(let o=0;o<n.length;o++)if(t===n[o])return n.splice(o,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){let n=this._anyOutgoingListeners;for(let o=0;o<n.length;o++)if(t===n[o])return n.splice(o,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){let n=this._anyOutgoingListeners.slice();for(let o of n)o.apply(this,t.data)}}};function ve(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}ve.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=Math.floor(t*10)&1?e+n:e-n}return Math.min(e,this.max)|0};ve.prototype.reset=function(){this.attempts=0};ve.prototype.setMin=function(e){this.ms=e};ve.prototype.setMax=function(e){this.max=e};ve.prototype.setJitter=function(e){this.jitter=e};var Se=class extends E{constructor(t,n){var o;super(),this.nsps={},this.subs=[],t&&typeof t=="object"&&(n=t,t=void 0),n=n||{},n.path=n.path||"/socket.io",this.opts=n,ie(this,n),this.reconnection(n.reconnection!==!1),this.reconnectionAttempts(n.reconnectionAttempts||1/0),this.reconnectionDelay(n.reconnectionDelay||1e3),this.reconnectionDelayMax(n.reconnectionDelayMax||5e3),this.randomizationFactor((o=n.randomizationFactor)!==null&&o!==void 0?o:.5),this.backoff=new ve({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(n.timeout==null?2e4:n.timeout),this._readyState="closed",this.uri=t;let r=n.parser||vt;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=n.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,this):this._reconnection}reconnectionAttempts(t){return t===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var n;return t===void 0?this._reconnectionDelay:(this._reconnectionDelay=t,(n=this.backoff)===null||n===void 0||n.setMin(t),this)}randomizationFactor(t){var n;return t===void 0?this._randomizationFactor:(this._randomizationFactor=t,(n=this.backoff)===null||n===void 0||n.setJitter(t),this)}reconnectionDelayMax(t){var n;return t===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,(n=this.backoff)===null||n===void 0||n.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new ye(this.uri,this.opts);let n=this.engine,o=this;this._readyState="opening",this.skipReconnect=!1;let r=F(n,"open",function(){o.onopen(),t&&t()}),a=m=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",m),t?t(m):this.maybeReconnectOnOpen()},u=F(n,"error",a);if(this._timeout!==!1){let m=this._timeout,g=this.setTimeoutFn(()=>{r(),a(new Error("timeout")),n.close()},m);this.opts.autoUnref&&g.unref(),this.subs.push(()=>{this.clearTimeoutFn(g)})}return this.subs.push(r),this.subs.push(u),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");let t=this.engine;this.subs.push(F(t,"ping",this.onping.bind(this)),F(t,"data",this.ondata.bind(this)),F(t,"error",this.onerror.bind(this)),F(t,"close",this.onclose.bind(this)),F(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(n){this.onclose("parse error",n)}}ondecoded(t){ge(()=>{this.emitReserved("packet",t)},this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,n){let o=this.nsps[t];return o?this._autoConnect&&!o.active&&o.connect():(o=new Ee(this,t,n),this.nsps[t]=o),o}_destroy(t){let n=Object.keys(this.nsps);for(let o of n)if(this.nsps[o].active)return;this._close()}_packet(t){let n=this.encoder.encode(t);for(let o=0;o<n.length;o++)this.engine.write(n[o],t.options)}cleanup(){this.subs.forEach(t=>t()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(t,n){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,n),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;let t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{let n=this.backoff.duration();this._reconnecting=!0;let o=this.setTimeoutFn(()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),!t.skipReconnect&&t.open(r=>{r?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",r)):t.onreconnect()}))},n);this.opts.autoUnref&&o.unref(),this.subs.push(()=>{this.clearTimeoutFn(o)})}}onreconnect(){let t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}};var _e={};function $e(e,t){typeof e=="object"&&(t=e,e=void 0),t=t||{};let n=Jt(e,t.path||"/socket.io"),o=n.source,r=n.id,a=n.path,u=_e[r]&&a in _e[r].nsps,m=t.forceNew||t["force new connection"]||t.multiplex===!1||u,g;return m?g=new Se(o,t):(_e[r]||(_e[r]=new Se(o,t)),g=_e[r]),n.query&&!t.query&&(t.query=n.queryKey),g.socket(n.path,t)}Object.assign($e,{Manager:Se,Socket:Ee,io:$e,connect:$e});var p=$e(),nn=!0,Te=!0,De=!0,Le=!0,Xn="violet",G=2,b=1,z=5;!navigator.userAgent.includes("Chrome")&&!navigator.userAgent.indexOf("Firefox")&&alert("Room of thought is only supported for firefox and chrome. Some features may be unavailable!");var D=0,C=0,un="#222222FF",W="#FF0000FF",i={systemSelect:document.getElementById("systemSelect"),AC13thAge:document.getElementById("AC13thAge"),mentalDef:document.getElementById("mentalDef"),physicalDef:document.getElementById("physicalDef"),AC4e:document.getElementById("AC4e"),refDef:document.getElementById("refDef"),fortDef:document.getElementById("fortDef"),willDef:document.getElementById("willDef"),diagonalTypeSelect:document.getElementById("diagonalType"),hAlignHandles:document.getElementById("hAlignHandles"),vAlignHandles:document.getElementById("vAlignHandles"),startGridAligner:document.getElementById("startGridAligner"),sideMenuCollapse:document.getElementById("sideMenuCollapse"),sideMenuToggle:document.getElementById("sideMenuToggle"),sideMenuToggleIcon:document.getElementById("sideMenuToggleIcon"),bulkTokenBox:document.getElementById("bulkTokenBox"),bulkTokenBoxHeader:document.getElementById("bulkTokenBoxHeader"),bulkTokenBoxBody:document.getElementById("bulkTokenBoxBody"),bulkTokenImageSelect:document.getElementById("bulkTokenImageSelect"),bulkTokenNameInput:document.getElementById("bulkTokenNameInput"),bulkTokenAmountInput:document.getElementById("bulkTokenAmountInput"),bulkTokenSize:document.getElementById("bulkTokenSize"),bulkTokenGroup:document.getElementById("bulkTokenGroup"),bulkTokenHP:document.getElementById("bulkTokenHP"),bulkTokenAC:document.getElementById("bulkTokenAC"),bulkTokenInit:document.getElementById("bulkTokenInit"),bulkTokenDex:document.getElementById("bulkTokenDex"),bulkTokenHideTracker:document.getElementById("bulkTokenHideTracker"),bulkTokenHideToken:document.getElementById("bulkTokenHideToken"),bulkTokenRollOnce:document.getElementById("bulkTokenRollOnce"),bulkTokenRollEach:document.getElementById("bulkTokenRollEach"),bulkTokenConfirm:document.getElementById("bulkTokenConfirm"),mapOptionsMenuBody:document.getElementById("mapOptionsMenuBody"),mapOptionsMenuClose:document.getElementById("mapOptionsMenuClose"),mapOptionsMenuBox:document.getElementById("mapOptionsMenuBox"),notesBox:document.getElementById("notesBox"),notesBoxTextArea:document.getElementById("notesBoxTextArea"),gridMap:document.getElementById("gridMap"),board:document.getElementById("board"),viewport:document.getElementById("viewport"),mapImage:document.getElementById("mapImage"),shapeMap:document.getElementById("shapeMap"),tokensDiv:document.getElementById("tokens"),blockersDiv:document.getElementById("blockers"),mapSourceSelect:document.getElementById("mapSource"),mapXInput:document.getElementById("mapX"),mapYInput:document.getElementById("mapY"),offsetXInput:document.getElementById("offsetX"),offsetYInput:document.getElementById("offsetY"),blockerTypeSelect:document.getElementById("blockerType"),initiativeTrackerDiv:document.getElementById("initiativeTrackerDiv"),noteArea:document.getElementById("notesTextArea"),detailsScreen:document.getElementById("detailsScreen"),initiativeInput:document.getElementById("detailsInitiative"),nameInput:document.getElementById("detailsNameInput"),acInput:document.getElementById("armorClass"),currentHpInput:document.getElementById("currentHitpoints"),maxHpInput:document.getElementById("maxHitpoints"),groupIdInput:document.getElementById("detailsGroup"),statusInput:document.getElementById("detailsStatusInput"),detailsIcon:document.getElementById("detailsIcon"),concentratingInput:document.getElementById("concentrating"),hideTrackerInput:document.getElementById("visibility"),hpIcon:document.getElementById("hitpointsIcon"),sideMenu:document.getElementById("sideMenu"),gridColorPicker:document.getElementById("gridColorPicker"),mapSelect:document.getElementById("mapSelect"),createNewMapButton:document.getElementById("createNewMapButton"),polyBlockers:document.getElementById("polyBlockers"),polyBlockerHandles:document.getElementById("polyBlockerHandles"),newPolyBlockerHandles:document.getElementById("newPolyBlockerHandles"),shapeHandles:document.getElementById("shapeHandles"),antiBlockerMap:document.getElementById("antiBlockerMap"),initSearch:document.getElementById("initSearch"),quickPolyButton:document.getElementById("quickPolyButton"),colorPickerButton:document.getElementById("colorPickerButton"),customMenu:document.getElementById("contextMenu"),sortTracker:document.getElementById("sortTracker"),toggleSettings:document.getElementById("toggleSettingsButton"),toggleGrid:document.getElementById("toggleGridButton"),toggleSnap:document.getElementById("toggleSnapButton"),colorPickerPreview:document.getElementById("colorPickerPreview"),redSlider:document.getElementById("redSlider"),greenSlider:document.getElementById("greenSlider"),blueSlider:document.getElementById("blueSlider"),opacitySlider:document.getElementById("opacitySlider"),toggleBlockerEditing:document.getElementById("toggleBlockerEditing"),clearTokens:document.getElementById("clearTokensButton"),clearDrawings:document.getElementById("clearDrawingsButton"),clearBlockers:document.getElementById("clearBlockersButton"),invertBlockers:document.getElementById("invertBlockerButton"),togglePlayerMode:document.getElementById("togglePlayerMode"),customSubMenu:document.getElementById("subContextMenu")};for(let[e,t]of Object.entries(i))if(t===null)throw new Error(`${e} is undefined! Check the IDs!`);var re=i.gridMap.getContext("2d"),S=i.antiBlockerMap.getContext("2d",{willReadFrequently:!0}),d,s,Ze={x:0,y:0},I={x:0,y:0},te={x:0,y:0,width:0,height:0},ce={x:0,y:0,radius:0},K={x:0,y:0,width:0,height:0},ue={x:0,y:0,destX:0,destY:0,range:100},ne={x:0,y:0,range:100,linkId:"0-0-0-0-0"},A={x:0,y:0,range:100,tokenSize:1,is90Deg:!1,linkId:"0-0-0-0-0"},y=!1,on=bn("shapeColor");on===""?vn("shapeColor",W):W=on;var f={blockerEditMode:!1,playerMode:!1,quickPolyBlockerMode:!1,gridAlignMode:!1,controlPressed:!1,isPanning:!1,isPlacingBlocker:!1,isPlacingSquare:!1,isPlacingLine:!1,isPlacing5ftLine:!1,isPlacingCone:!1,isMovingShape:!1,isMovingCone:!1,isMoving5ftLine:!1,isDraggingBlocker:!1,isPlacingBulkOrigin:!1},nt={x:0,y:0},$={x:0,y:0},Y={x:0,y:0},_,k,B,q,l,be="",V,de=4,Ye=0,Ie={x:0,y:0},we=new Array,x=new Image;X();function qn(){if(bn("isDM")=="1")y=!0;else{let e=document.getElementsByClassName("dmOnly");for(let t=e.length-1;t>=0;t--)e[t]?.parentElement?.removeChild(e[t])}gn(),si(W),i.quickPolyButton.style.display=d.blockerType==1&&y?"":"none",d.blockerType||p.emit("switchBlockerType",{type:0}),i.blockerTypeSelect.value=d.blockerType?.toString()??"0",y?(i.shapeMap.style.zIndex="941",de=500):de=0}p.on("pingAt",e=>{let t=JSON.parse(e),n=document.createElement("div");n.className="ping",n.style.left=t.pingX.toString(),n.style.top=t.pingY.toString(),n.style.setProperty("transform","translate(-50%, -50%)"),i.board.appendChild(n),setTimeout(()=>{i.board.removeChild(n)},5e3)});p.on("currentMapData",e=>{if(d=JSON.parse(e),be!=e){nn&&(qn(),nn=!1),un=d.gridColor,document.body.style.setProperty("--antiBlocker-color",y&&!f.playerMode?"#00000080":"#000000FF"),document.body.style.setProperty("--blocker-color",d.antiBlockerOn?y&&!f.playerMode?"#00000080":"#000000FF":"#00000000"),i.mapSelect.innerHTML="";for(let t of d.maps)i.mapSelect.insertAdjacentHTML("beforeend",`<option value="${t}">${t}</option>`);if(i.mapSelect.value=d.mapName,document.activeElement!=i.bulkTokenImageSelect){i.bulkTokenImageSelect.innerHTML="";let t=document.createElement("option");t.value="number",t.innerText="Auto number",i.bulkTokenImageSelect.append(t);for(let n of d.tokenList)i.bulkTokenImageSelect.insertAdjacentHTML("beforeend",`<option value="${n}">${n}</option>`);for(let n of d.dmTokenList)i.bulkTokenImageSelect.insertAdjacentHTML("beforeend",`<option value="${n}">${n}</option>`)}if(document.activeElement!=i.mapSourceSelect){i.mapSourceSelect.innerHTML="";for(let t of d.mapSourceList)i.mapSourceSelect.insertAdjacentHTML("beforeend",`<option value="${t}">${t}</option>`);i.mapSourceSelect.value=d.map}if(document.activeElement!=i.mapYInput&&(i.mapYInput.value=d.y.toString()),document.activeElement!=i.mapXInput&&(i.mapXInput.value=d.x.toString()),document.activeElement!=i.offsetXInput&&(i.offsetXInput.value=d.offsetX.toString()),document.activeElement!=i.offsetYInput&&(i.offsetYInput.value=d.offsetY.toString()),document.activeElement!=i.gridColorPicker&&(i.gridColorPicker.value=d.gridColor.toString()),document.activeElement!=i.diagonalTypeSelect&&(i.diagonalTypeSelect.value=d.diagonalMovement),document.activeElement!=i.systemSelect&&(i.systemSelect.value=d.system),D=d.offsetX,C=d.offsetY,d.map!=(V?V.map:""))console.log("Switching/Redrawing map!"),k="0-0-0-0-0",B="0-0-0-0-0",q="0-0-0-0-0",i.detailsScreen.style.display="none",x.src="/public/maps/"+d.map,x.onload=()=>{i.blockerTypeSelect.value=d.blockerType?.toString()??"0",i.mapSourceSelect.value=d.map,i.mapYInput.value=d.y.toString(),i.mapXInput.value=d.x.toString(),i.offsetXInput.value=d.offsetX.toString(),i.offsetYInput.value=d.offsetY.toString(),f.quickPolyBlockerMode=!1,i.quickPolyButton.style.display=d.blockerType==1&&y?"":"none",U(),X(),be=e,V=be?JSON.parse(be):V};else{let t=!0;V.x!==d.x&&(t=!1),V.y!==d.y&&(t=!1),V.offsetX!==d.offsetX&&(t=!1),V.offsetY!==d.offsetY&&(t=!1),V.gridColor!==d.gridColor&&(t=!1),U(t),be=e,V=be?JSON.parse(be):V}i.AC4e.style.display=d.system!=="4e"?"none":"",i.AC13thAge.style.display=d.system!=="13thAge"?"none":""}});function dn(e){return d.tokens.find(t=>t.id===e)}var ae=new Array;function Q(e,t,n,o,r,a,u,m,g=!0){let h={x:0,y:0},w=[!1];e.draggable=!1,e.setAttribute("dragging","0"),e.setAttribute("checkBlocker",a?.toString()??"false"),e.addEventListener("mousedown",v=>{if(v.button===0&&!(v.target!==null&&m!==void 0&&yn(v.target).includes(m))){if(a&&!pe(v)&&(!y||f.playerMode)){v.preventDefault(),f.isPanning=!0,$.x=v.pageX,$.y=v.pageY,Y.x=i.viewport.scrollLeft,Y.y=i.viewport.scrollTop,document.body.style.cursor="grabbing";return}fe(),he(),v.preventDefault(),e.style.cursor="grabbing",e.style.userSelect="none",ae.push(e),e.setAttribute("dragging","1"),g?(h.x=(v.pageX+i.viewport.scrollLeft)/(1+c/20)-e.offsetLeft,h.y=(v.pageY+i.viewport.scrollTop)/(1+c/20)-e.offsetTop):(h.x=v.pageX-e.offsetLeft,h.y=v.pageY-e.offsetTop),n&&n(v,h)}}),e.addEventListener("release",function(v){e.style.cursor="",e.style.userSelect="",ae.splice(ae.indexOf(e),1),o&&o(v.detail.event,h)}),t===!0&&(r!==void 0?e.addEventListener("followMouse",function(v){u&&u(w,v.detail.event),(!u||w[0])&&(g?(e.style.left=((v.detail.event.pageX+i.viewport.scrollLeft)/(1+c/20)-h.x).toString()+"px",e.style.top=((v.detail.event.pageY+i.viewport.scrollTop)/(1+c/20)-h.y).toString()+"px"):(e.style.left=(v.detail.event.pageX-h.x).toString()+"px",e.style.top=(v.detail.event.pageY-h.y).toString()+"px"),r(v.detail.event,h))}):e.addEventListener("followMouse",function(v){u&&u(w,v.detail.event),(!u||w[0])&&(g?(e.style.left=((v.detail.event.pageX+i.viewport.scrollLeft)/(1+c/20)-h.x).toString()+"px",e.style.top=((v.detail.event.pageY+i.viewport.scrollTop)/(1+c/20)-h.y).toString()+"px"):(e.style.left=(v.detail.event.pageX-h.x).toString()+"px",e.style.top=(v.detail.event.pageY-h.y).toString()+"px"))}))}var bt=!1;window.addEventListener("mousemove",e=>{bt=!1;for(let t of ae){if(t.getAttribute("dragging")!=="1")return;bt=!0,t.dispatchEvent(new CustomEvent("followMouse",{detail:{event:e}}))}bt&&e.preventDefault()});window.addEventListener("mouseup",e=>{if(e.button===0){for(let t of ae)if(t.getAttribute("dragging")==="1"){if(t.setAttribute("dragging","0"),t.getAttribute("checkBlocker")==="true"&&!pe(e)&&(!y||f.playerMode)){t.style.cursor="",t.style.userSelect="",ae.splice(ae.indexOf(t),1),t.parentElement?.removeChild(t),t.dispatchEvent(new CustomEvent("dragcancel",{detail:{event:e}}));return}t.dispatchEvent(new CustomEvent("release",{detail:{event:e}}))}}});var c=0;window.addEventListener("wheel",e=>{!e.ctrlKey&&!e.metaKey||(e.preventDefault(),e.deltaY<0&&(c+=1,i.board.style.transform="scale("+(1+c/20).toString()+")",i.viewport.scrollLeft=i.viewport.scrollLeft*((20+c)/(20+c-1)),i.viewport.scrollTop=i.viewport.scrollTop*((20+c)/(20+c-1)),e.preventDefault()),e.deltaY>0&&(c-=1,i.board.style.transform="scale("+(1+c/20).toString()+")",i.viewport.scrollLeft=i.viewport.scrollLeft/((20+c)/(20+c-1)),i.viewport.scrollTop=i.viewport.scrollTop/((20+c)/(20+c-1)),e.preventDefault()))},{passive:!1});var rn=i.initiativeTrackerDiv.scrollHeight,sn=0;i.initiativeTrackerDiv.onscroll=()=>{i.initiativeTrackerDiv.scrollHeight==rn?sn=i.initiativeTrackerDiv.scrollTop*window.devicePixelRatio:(i.initiativeTrackerDiv.scrollTop=sn/window.devicePixelRatio,rn=i.initiativeTrackerDiv.scrollHeight)};i.startGridAligner.onclick=()=>{if(f.gridAlignMode){let e=me(i.vAlignHandles).map(g=>Number(g.style.left.slice(0,-2))).sort((g,h)=>g-h),t=me(i.hAlignHandles).map(g=>Number(g.style.top.slice(0,-2))).sort((g,h)=>g-h),n={x:e[0],y:t[0]},o=e.slice(1).map((g,h)=>g-e[h]),r=t.slice(1).map((g,h)=>g-t[h]),a=o.reduce((g,h)=>g+h,0)/o.length,u=r.reduce((g,h)=>g+h,0)/r.length,m={x:x.width/a,y:x.height/u};!isNaN(m.x)&&n.x&&confirm(`Apply new X settings?
X: ${m.x} 
Offset: ${n.x}`)&&(p.emit("setMapData",{x:m.x,offsetX:n.x}),i.vAlignHandles.innerHTML=""),!isNaN(m.y)&&n.y&&confirm(`Apply new Y settings?
Y: ${m.y} 
Offset: ${n.y}`)&&(p.emit("setMapData",{y:m.y,offsetY:n.y}),i.hAlignHandles.innerHTML="")}f.gridAlignMode=!f.gridAlignMode,X()};i.gridColorPicker.onchange=()=>{p.emit("setMapData",{gridColor:i.gridColorPicker.value})};i.systemSelect.onchange=()=>{p.emit("setMapData",{system:i.systemSelect.value})};i.mapSelect.onchange=()=>{p.emit("changeSelectedMap",{selectedMap:i.mapSelect.value})};i.createNewMapButton.onclick=()=>{let e=prompt("Enter new map name:");e!==null&&p.emit("createNewMap",{name:e})};i.mapSourceSelect.onchange=()=>{p.emit("setMapData",{map:i.mapSourceSelect.value})};i.mapYInput.onchange=()=>{p.emit("setMapData",{y:parseFloat(i.mapYInput.value)})};i.mapXInput.onchange=()=>{p.emit("setMapData",{x:parseFloat(i.mapXInput.value)})};i.offsetXInput.onchange=()=>{p.emit("setMapData",{offsetX:parseFloat(i.offsetXInput.value)})};i.offsetYInput.onchange=()=>{p.emit("setMapData",{offsetY:parseFloat(i.offsetYInput.value)})};i.diagonalTypeSelect.onchange=()=>{p.emit("setMapData",{diagonalMovement:i.diagonalTypeSelect.value})};function U(e){ae=ae.filter(t=>document.body.contains(t)),i.polyBlockerHandles.innerHTML="",e||(i.polyBlockers.setAttribute("width",x.width.toString()),i.polyBlockers.setAttribute("height",x.height.toString()),i.shapeMap.style.width=`${x.width}`,i.shapeMap.style.height=`${x.height}`,i.antiBlockerMap.width=x.width,i.antiBlockerMap.height=x.height,i.gridMap.width=x.width,i.gridMap.height=x.height,s={x:x.width/d.x,y:x.height/d.y,min:Math.min(x.width/d.x,x.height/d.y)},i.mapImage.src=x.src),xt(),document.body.style.setProperty("--antiBlocker-color",y&&!f.playerMode?"#00000080":"#000000FF"),document.body.style.setProperty("--blocker-color",d.antiBlockerOn?y&&!f.playerMode?"#00000080":"#000000FF":"#00000000"),S.clearRect(0,0,i.antiBlockerMap.width,i.antiBlockerMap.height),d.antiBlockerOn&&ei(),i.polyBlockers.innerHTML="",i.blockersDiv.innerHTML="",d.blockerType==0&&(i.polyBlockerHandles.style.visibility="hidden",Qn()),d.blockerType==1&&(i.polyBlockerHandles.style.visibility="",jn()),ti(),pn(),(V===void 0||JSON.stringify(V.tokens)!==JSON.stringify(d.tokens))&&(console.log("First time or change detected!"),mn())}function pn(){i.shapeMap.innerHTML="",i.shapeHandles.innerHTML="";for(let e of d.drawings)if(!(!e.visible&&(!y||f.playerMode)))switch(e.shape){case"circle":Kn(e);break;case"square":Wn(e);break;case"cone":e.is90Deg?Jn(e):Gn(e);break;case"5ftLine":Un(e);break;case"vertexLine":Vn(e);break}P()}function Fn(){i.shapeHandles.innerHTML="";for(let e of me(i.shapeMap))e.dispatchEvent(new Event("checkSelected"))}function Vn(e){let t=document.createElementNS("http://www.w3.org/2000/svg","polyline");t.style.stroke=e.trueColor,t.style.strokeWidth=`${G}`,t.style.fill="none",t.style.pointerEvents="none",t.setAttribute("points",e.verts.map(o=>`${o.x},${o.y}`).join(" "));let n=document.createElementNS("http://www.w3.org/2000/svg","polyline");n.style.stroke="#00000001",n.style.strokeWidth=`${G*3}`,n.style.fill="none",n.style.pointerEvents="painted",n.setAttribute("points",e.verts.map(o=>`${o.x},${o.y}`).join(" ")),t.addEventListener("checkSelected",()=>{if(q===e.id)for(let o of e.verts){let r=document.createElement("div");r.style.position="absolute",r.style.left=o.x.toString(),r.style.top=o.y.toString();let a=document.createElement("div");a.className="shapeHandle",a.draggable=!0,a.style.left="-0.25vw",a.style.top="-0.25vw",Q(a,!0,void 0,u=>{(u.pageX+i.viewport.scrollLeft)/(1+c/20)!==e.x&&(u.pageY+i.viewport.scrollTop)/(1+c/20)!==e.y&&(o.x=(u.pageX+i.viewport.scrollLeft)/(1+c/20),o.y=(u.pageY+i.viewport.scrollTop)/(1+c/20),p.emit("editDrawing",{id:e.id,verts:e.verts}))},void 0,!0),a.addEventListener("contextmenu",u=>{u.preventDefault(),O(u,[{text:"Remove vert",hasSubMenu:!1,callback:()=>{p.emit("removeVert",{type:"line",id:e.id,vertID:o.id})}}])}),r.appendChild(a),i.shapeHandles.appendChild(r)}}),n.addEventListener("mousedown",o=>{o.button===0&&(k="0-0-0-0-0",B="0-0-0-0-0",q=e.id,P(),I.x=e.verts[0].x-(o.pageX+i.viewport.scrollLeft)/(1+c/20),I.y=e.verts[0].y-(o.pageY+i.viewport.scrollTop)/(1+c/20),document.body.style.cursor="pointer",_=e.id,f.isMovingShape=!0)}),n.addEventListener("contextmenu",o=>{o.preventDefault();let r=[{text:"Erase shape",hasSubMenu:!1,callback:()=>{p.emit("removeDrawing",{id:e.id})}},{text:"Add vert",hasSubMenu:!1,callback:()=>{let a=(o.pageX+i.viewport.scrollLeft)/(1+c/20),u=(o.pageY+i.viewport.scrollTop)/(1+c/20),m=e.verts[0];for(let[g,h]of Object.entries(e.verts)){if(g==="0")continue;let w=Math.min(h.x,m.x),v=Math.min(h.y,m.y),M=Math.abs(h.x-m.x),N=Math.abs(h.y-m.y);if(a>=w&&a<=w+M&&u>=v&&u<=v+N){e.verts.splice(Number(g),0,{id:crypto.randomUUID(),x:a,y:u});break}m=h}p.emit("editDrawing",{id:e.id,verts:e.verts})}},{text:"Set shape group",hasSubMenu:!1,callback:()=>{let a=prompt("Enter shape group number: ",e.group?e.group.toString():"");if(a===null)return;if(a===""){p.emit("editDrawing",{id:e.id,group:null});return}let u=parseInt(a);isNaN(u)||p.emit("editDrawing",{id:e.id,group:u})}}];y&&r.push({text:e.visible?"Hide shape":"Reveal shape",hasSubMenu:!1,callback:()=>{p.emit("editDrawing",{id:e.id,visible:!e.visible})}}),O(o,r)}),i.shapeMap.appendChild(n),i.shapeMap.appendChild(t)}function Kn(e){let t=e.radius*s.min,n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.style.stroke=e.trueColor,n.style.strokeWidth=G.toString(),n.style.fill="none",n.style.pointerEvents="none",n.setAttribute("cx",e.x.toString()),n.setAttribute("cy",e.y.toString()),n.setAttribute("r",t.toString());let o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.style.stroke="#00000001",o.style.strokeWidth=(G*3).toString(),o.style.fill="none",o.style.pointerEvents="painted",o.setAttribute("cx",e.x.toString()),o.setAttribute("cy",e.y.toString()),o.setAttribute("r",t.toString()),o.addEventListener("mousedown",r=>{r.button!==0||e.link||(k="0-0-0-0-0",B="0-0-0-0-0",q="0-0-0-0-0",P(),i.detailsScreen.style.display="none",I.x=e.x-(r.pageX+i.viewport.scrollLeft)/(1+c/20),I.y=e.y-(r.pageY+i.viewport.scrollTop)/(1+c/20),document.body.style.cursor="pointer",_=e.id,f.isMovingShape=!0)}),o.addEventListener("contextmenu",r=>{r.preventDefault();let a=[{text:"Erase shape",hasSubMenu:!1,callback:()=>{p.emit("removeDrawing",{id:e.id})}},{text:"Set shape group",hasSubMenu:!1,callback:()=>{let u=prompt("Enter shape group number: ",e.group?.toString()??"");if(u===null){p.emit("editDrawing",{id:e.id,group:null});return}let m=parseInt(u);isNaN(m)||p.emit("editDrawing",{id:e.id,group:m})}},{text:"Edit radius",hasSubMenu:!1,callback:()=>{let u=d.tokens.find(g=>g.id===e.link),m=se("Please enter the new radius",u!==void 0?(e.radius-u.size/2)*z:e.radius*z);m===null||isNaN(m)||(u!==void 0?m=m/z+u.size/2:m=m/z,p.emit("editDrawing",{radius:m,id:e.id}))}}];y&&a.push({text:e.visible?"Hide shape":"Reveal shape",hasSubMenu:!1,callback:()=>{p.emit("editDrawing",{id:e.id,visible:!e.visible})}}),O(r,a)}),i.shapeMap.appendChild(n),i.shapeMap.appendChild(o)}function Wn(e){let t=document.createElementNS("http://www.w3.org/2000/svg","rect");t.style.stroke=e.trueColor,t.style.strokeWidth=G.toString(),t.style.fill="none",t.style.pointerEvents="none",t.setAttribute("width",e.width.toString()),t.setAttribute("height",e.height.toString()),t.setAttribute("x",e.x.toString()),t.setAttribute("y",e.y.toString());let n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.style.stroke="#00000001",n.style.strokeWidth=(3*G).toString(),n.style.fill="none",n.style.pointerEvents="painted",n.setAttribute("width",e.width.toString()),n.setAttribute("height",e.height.toString()),n.setAttribute("x",e.x.toString()),n.setAttribute("y",e.y.toString()),n.addEventListener("mousedown",o=>{o.button===0&&(k="0-0-0-0-0",B="0-0-0-0-0",q="0-0-0-0-0",P(),i.detailsScreen.style.display="none",I.x=e.x-(o.pageX+i.viewport.scrollLeft)/(1+c/20),I.y=e.y-(o.pageY+i.viewport.scrollTop)/(1+c/20),document.body.style.cursor="pointer",_=e.id,f.isMovingShape=!0)}),n.addEventListener("contextmenu",o=>{o.preventDefault();let r=[{text:"Erase shape",hasSubMenu:!1,callback:()=>{p.emit("removeDrawing",{id:e.id})}},{text:"Set shape group",hasSubMenu:!1,callback:()=>{let a=prompt("Enter shape group number: ",e.group?e.group.toString():"");if(a===null){p.emit("editDrawing",{id:e.id,group:null});return}let u=parseInt(a);isNaN(u)||p.emit("editDrawing",{id:e.id,group:u})}}];y&&r.push({text:e.visible?"Hide shape":"Reveal shape",hasSubMenu:!1,callback:()=>{p.emit("editDrawing",{id:e.id,visible:!e.visible})}}),O(o,r)}),i.shapeMap.appendChild(n),i.shapeMap.appendChild(t)}function Un(e){let t=d.tokens.find(h=>h.id===e.link);if(t===void 0){console.error("Could not find token linked to 5ft line!");return}let n={x:Math.round(e.x+Math.cos(e.angle)*s.x*.5*t.size),y:Math.round(e.y+Math.sin(e.angle)*s.y*.5*t.size)},o={x:Math.round(n.x+Math.cos(e.angle-.5*Math.PI)*s.x*.5),y:Math.round(n.y+Math.sin(e.angle-.5*Math.PI)*s.y*.5)},r={x:Math.round(o.x+Math.cos(e.angle)*e.range*s.x),y:Math.round(o.y+Math.sin(e.angle)*e.range*s.y)},a={x:Math.round(n.x+Math.cos(e.angle+.5*Math.PI)*s.x*.5),y:Math.round(n.y+Math.sin(e.angle+.5*Math.PI)*s.y*.5)},u={x:Math.round(a.x+Math.cos(e.angle)*e.range*s.x),y:Math.round(a.y+Math.sin(e.angle)*e.range*s.y)},m=document.createElementNS("http://www.w3.org/2000/svg","path");m.style.stroke=e.trueColor,m.style.strokeWidth=G.toString(),m.style.fill="none",m.style.pointerEvents="none",m.setAttribute("d",`M ${o.x},${o.y} L ${a.x},${a.y} L ${u.x},${u.y} L ${r.x},${r.y} Z`);let g=document.createElementNS("http://www.w3.org/2000/svg","path");g.style.stroke="#00000001",g.style.strokeWidth=(3*G).toString(),g.style.fill="none",g.style.pointerEvents="painted",g.setAttribute("d",`M ${o.x},${o.y} L ${a.x},${a.y} L ${u.x},${u.y} L ${r.x},${r.y} Z`),g.addEventListener("mousedown",h=>{k="0-0-0-0-0",B="0-0-0-0-0",q="0-0-0-0-0",P(),i.detailsScreen.style.display="none",h.button===0&&(document.body.style.cursor="pointer",I.x=e.x,I.y=e.y,Ye=Math.atan2((h.pageY+i.viewport.scrollTop)/(1+c/20)-I.y,(h.pageX+i.viewport.scrollLeft)/(1+c/20)-I.x),_=e.id,f.isMoving5ftLine=!0)}),g.addEventListener("contextmenu",h=>{h.preventDefault();let w=[{text:"Erase shape",hasSubMenu:!1,callback:()=>{p.emit("removeDrawing",{id:e.id})}},{text:"Set shape group",hasSubMenu:!1,callback:()=>{let v=prompt("Enter shape group number: ",e.group?e.group.toString():"");if(v===null){p.emit("editDrawing",{id:e.id,group:null});return}let M=parseInt(v);isNaN(M)||p.emit("editDrawing",{id:e.id,group:M})}},{text:"Edit range",hasSubMenu:!1,callback:()=>{let v=Number.parseFloat(prompt("Please enter the new range",(e.range*z).toString())??"");isNaN(v)||(v=v/z,p.emit("editDrawing",{range:v,id:e.id}))}}];y&&w.push({text:e.visible?"Hide shape":"Reveal shape",hasSubMenu:!1,callback:()=>{p.emit("editDrawing",{id:e.id,visible:!e.visible})}}),O(h,w)}),i.shapeMap.appendChild(m),i.shapeMap.appendChild(g)}function Gn(e){let t=e.angle,n=dn(e.link);if(n===void 0)throw new Error(`Couldn't find token ${e.link}! Cant link to shape ${e.id}!`);let o=Math.round(e.x+Math.cos(t)*.5*n.size*s.x),r=Math.round(e.y+Math.sin(t)*.5*n.size*s.y),a=Math.round(r+Math.sin(t)*e.range*s.y),u=Math.round(o+Math.cos(t)*e.range*s.x),m=Math.round(.5*(-a+r)+u),g=Math.round(.5*(u-o)+a),h=Math.round(.5*(a-r)+u),w=Math.round(.5*(-u+o)+a),v=document.createElementNS("http://www.w3.org/2000/svg","path");v.style.stroke=e.trueColor,v.style.strokeWidth=G.toString(),v.style.fill="none",v.style.pointerEvents="none",v.setAttribute("d",`M ${o},${r} L ${m},${g} L ${h},${w} Z`);let M=document.createElementNS("http://www.w3.org/2000/svg","path");M.style.stroke="#00000001",M.style.strokeWidth=(3*G).toString(),M.style.fill="none",M.style.pointerEvents="painted",M.setAttribute("d",`M ${o},${r} L ${m},${g} L ${h},${w} Z`),M.addEventListener("mousedown",N=>{k="0-0-0-0-0",B="0-0-0-0-0",q="0-0-0-0-0",P(),i.detailsScreen.style.display="none",N.button===0&&(document.body.style.cursor="pointer",I.x=e.x,I.y=e.y,Ye=Math.atan2((N.pageY+i.viewport.scrollTop)/(1+c/20)-I.y,(N.pageX+i.viewport.scrollLeft)/(1+c/20)-I.x),_=e.id,f.isMovingCone=!0)}),M.addEventListener("contextmenu",N=>{N.preventDefault();let Z=[{text:"Erase shape",hasSubMenu:!1,callback:()=>{p.emit("removeDrawing",{id:e.id})}},{text:"Set shape group",hasSubMenu:!1,callback:()=>{let ee=prompt("Enter shape group number: ",e.group?e.group.toString():"");if(ee===null){p.emit("editDrawing",{id:e.id,group:null});return}let Tt=parseInt(ee);isNaN(Tt)||p.emit("editDrawing",{id:e.id,group:Tt})}},{text:"Edit range",hasSubMenu:!1,callback:()=>{let ee=Number.parseFloat(prompt("Please enter the new range",(e.range*z).toString())??"");isNaN(ee)||(ee=ee/z,p.emit("editDrawing",{range:ee,id:e.id}))}}];y&&Z.push({text:e.visible?"Hide shape":"Reveal shape",hasSubMenu:!1,callback:()=>{p.emit("editDrawing",{id:e.id,visible:!e.visible})}}),O(N,Z)}),i.shapeMap.appendChild(v),i.shapeMap.appendChild(M)}function Jn(e){let t=e.angle,n=dn(e.link);if(n===void 0)throw new Error(`Couldn't find token ${e.link}! Cant link to shape ${e.id}!`);let o=Math.round(e.x+Math.cos(t)*.5*n.size*s.x),r=Math.round(e.y+Math.sin(t)*.5*n.size*s.y),a=Math.round(o+Math.cos(t+.25*Math.PI)*e.range*s.x),u=Math.round(r+Math.sin(t+.25*Math.PI)*e.range*s.y),m=Math.round(o+Math.cos(t-.25*Math.PI)*e.range*s.x),g=Math.round(r+Math.sin(t-.25*Math.PI)*e.range*s.y),h=Math.sqrt(Math.pow(a-o,2)+Math.pow(u-r,2)),w=document.createElementNS("http://www.w3.org/2000/svg","path");w.style.stroke=e.trueColor,w.style.strokeWidth=G.toString(),w.style.fill="none",w.style.pointerEvents="none",w.setAttribute("d",`M ${o},${r} L ${a},${u} A ${h},${h} 0 0,0 ${m},${g} Z`);let v=document.createElementNS("http://www.w3.org/2000/svg","path");v.style.stroke="#00000001",v.style.strokeWidth=(3*G).toString(),v.style.fill="none",v.style.pointerEvents="painted",v.setAttribute("d",`M ${o},${r} L ${a},${u} A ${h},${h} 0 0,0 ${m},${g} Z`),v.addEventListener("mousedown",M=>{k="0-0-0-0-0",B="0-0-0-0-0",q="0-0-0-0-0",P(),i.detailsScreen.style.display="none",M.button===0&&(document.body.style.cursor="pointer",I.x=e.x,I.y=e.y,Ye=Math.atan2((M.pageY+i.viewport.scrollTop)/(1+c/20)-I.y,(M.pageX+i.viewport.scrollLeft)/(1+c/20)-I.x),_=e.id,f.isMovingCone=!0)}),v.addEventListener("contextmenu",M=>{M.preventDefault();let N=[{text:"Erase shape",hasSubMenu:!1,callback:()=>{p.emit("removeDrawing",{id:e.id})}},{text:"Set shape group",hasSubMenu:!1,callback:()=>{let Z=prompt("Enter shape group number: ",e.group?e.group.toString():"");if(Z===null){p.emit("editDrawing",{id:e.id,group:null});return}let ee=parseInt(Z);isNaN(ee)||p.emit("editDrawing",{id:e.id,group:ee})}},{text:"Edit range",hasSubMenu:!1,callback:()=>{let Z=Number.parseFloat(prompt("Please enter the new range",(e.range*z).toString())??"");isNaN(Z)||(Z=Z/z,p.emit("editDrawing",{range:Z,id:e.id}))}}];y&&N.push({text:e.visible?"Hide shape":"Reveal shape",hasSubMenu:!1,callback:()=>{p.emit("editDrawing",{id:e.id,visible:!e.visible})}}),O(M,N)}),i.shapeMap.appendChild(w),i.shapeMap.appendChild(v)}function jn(){if(!f.isDraggingBlocker){for(let e of d.polyBlockers){let t=document.createElementNS("http://www.w3.org/2000/svg","polygon");if(t.style.position="absolute",t.setAttribute("points",e.verts.map(n=>`${n.x},${n.y}`).join(" ")),t.setAttribute("class","polyBlocker"),t.addEventListener("checkSelected",()=>{if(e.id!==B){e.inactive&&y&&!f.playerMode?(t.style.stroke="red",t.style.strokeDasharray="4"):(t.style.stroke="",t.style.strokeDasharray="");return}t.style.stroke="violet",t.style.strokeDasharray="4";for(let n of e.verts){let o=document.createElement("div");o.style.position="absolute",o.style.left=n.x.toString(),o.style.top=n.y.toString(),o.title=e.verts.indexOf(n).toString();let r=document.createElement("div");r.className="polyBlockerHandle",r.style.left="-0.35vw",r.style.top="-0.35vw",Q(r,!0,void 0,a=>{p.emit("editVert",{id:B,vertID:n.id,x:(a.pageX+i.viewport.scrollLeft)/(1+c/20),y:(a.pageY+i.viewport.scrollTop)/(1+c/20)})}),r.addEventListener("contextmenu",a=>{a.preventDefault(),O(a,[{text:"Add new vert",hasSubMenu:!1,callback:()=>{p.emit("addVert",{id:e.id,vertID:n.id}),P()}},{text:"Remove vert",hasSubMenu:!1,callback:()=>{e.verts.length>3?p.emit("removeVert",{type:"blocker",id:e.id,vertID:n.id}):alert("There are too few verts in that poly blocker to remove one!")}}])}),o.appendChild(r),i.polyBlockerHandles.appendChild(o)}}),!d.antiBlockerOn&&!e.inactive){S.beginPath(),S.fillStyle=document.body.style.getPropertyValue("--antiBlocker-color"),S.moveTo(e.verts[0].x,e.verts[0].y);for(let n of e.verts)S.lineTo(n.x,n.y);S.fill("nonzero")}if(i.polyBlockers.appendChild(t),!y||f.playerMode){if(e.inactive){t.style.pointerEvents="none";continue}if(d.antiBlockerOn){t.style.pointerEvents="none";continue}t.addEventListener("contextmenu",n=>{n.preventDefault()}),Q(t,!1,n=>{f.isPanning=!0,$.x=n.pageX,$.y=n.pageY,Y.x=i.viewport.scrollLeft,Y.y=i.viewport.scrollTop,document.body.style.cursor="grabbing"},()=>{document.body.style.cursor=""});continue}if(!f.blockerEditMode||f.quickPolyBlockerMode){t.style.pointerEvents="none";continue}t.addEventListener("dragover",n=>{n.preventDefault()}),Q(t,!0,n=>{B=e.id,k="0-0-0-0-0",q="0-0-0-0-0",Ie.x=(n.pageX+i.viewport.scrollLeft)/(1+c/20),Ie.y=(n.pageY+i.viewport.scrollTop)/(1+c/20),P()},n=>{let o=-Ie.x+(n.pageX+i.viewport.scrollLeft)/(1+c/20),r=-Ie.y+(n.pageY+i.viewport.scrollTop)/(1+c/20);o!=0&&r!=0&&p.emit("movePolyBlocker",{id:e.id,offsetX:o,offsetY:r})},n=>{t.setAttribute("transform","matrix(1,0,0,1,"+(-Ie.x+(n.pageX+i.viewport.scrollLeft)/(1+c/20)).toString()+", "+(-Ie.y+(n.pageY+i.viewport.scrollTop)/(1+c/20)).toString()+")")}),t.addEventListener("contextmenu",n=>{n.preventDefault();let o=[{text:e.inactive?"Activate":"Deactivate",hasSubMenu:!1,callback:()=>{p.emit("togglePolyBlocker",{id:e.id})}},{text:"Remove blocker",hasSubMenu:!1,callback:()=>{B="0-0-0-0-0",p.emit("removePolyBlocker",{id:e.id})}}];O(n,o)})}P()}}function Qn(){if(!f.isDraggingBlocker)for(let e of d.blockers){let t=document.createElement("div"),n=document.createElement("div");if(t.className="blocker",t.style.left=e.x+"px",t.style.top=e.y+"px",t.style.width=e.width+"px",t.style.height=e.height+"px",t.addEventListener("checkSelected",()=>{f.blockerEditMode?(t.style.outline=e.id==B?`0.3vh dashed ${Xn}`:"",t.style.zIndex=e.id==B?"1002":"1001"):(t.style.zIndex="",t.style.outline="")}),d.antiBlockerOn||(S.beginPath(),S.fillStyle=document.body.style.getPropertyValue("--antiBlocker-color"),S.fillRect(e.x,e.y,e.width,e.height)),t.appendChild(n),i.blockersDiv.appendChild(t),!y||f.playerMode){if(t.addEventListener("contextmenu",o=>{o.preventDefault()}),t.addEventListener("mousedown",o=>{o.button===0&&(f.isPanning=!0,$.x=o.pageX/(1+c/20),$.y=o.pageY/(1+c/20),Y.x=i.viewport.scrollLeft,Y.y=i.viewport.scrollTop,document.body.style.cursor="grabbing")}),t.addEventListener("mousemove",o=>{f.isPanning&&(i.viewport.scrollLeft=Y.x-(o.pageX/(1+c/20)-$.x),i.viewport.scrollTop=Y.y-(o.pageY/(1+c/20)-$.y))}),d.antiBlockerOn){n.style.pointerEvents="none",t.style.pointerEvents="none";continue}n.style.userSelect="none",t.style.userSelect="none",n.draggable=!1,t.draggable=!1;continue}if(n.style.width=e.width+"px",n.style.height=e.height+"px",!f.blockerEditMode||f.isPlacingBlocker){n.style.pointerEvents="none",t.style.pointerEvents="none";continue}n.draggable=!0,t.style.resize="both",t.addEventListener("mousedown",o=>{o.button===0&&(B=e.id,k="0-0-0-0-0",q="0-0-0-0-0",P(),pn())}),t.addEventListener("dragover",o=>{o.preventDefault()}),t.addEventListener("contextmenu",o=>{o.preventDefault(),B=e.id,k="0-0-0-0-0",q="0-0-0-0-0",P(),O(o,[{text:"Remove blocker",hasSubMenu:!1,callback:()=>{B="0-0-0-0-0",p.emit("removeBlocker",{id:e.id})}}])}),t.addEventListener("mouseup",o=>{o.button===0&&(f.isDraggingBlocker=!1,n.style.width=e.width+"px",n.style.height=e.height+"px",!(e.width===t.offsetWidth||e.height===t.offsetHeight)&&p.emit("editBlocker",{id:e.id,x:e.x,y:e.y,width:t.offsetWidth,height:t.offsetHeight}))}),n.addEventListener("dragstart",o=>{f.isDraggingBlocker=!0,Ze.x=e.x-(o.pageX+i.viewport.scrollLeft)/(1+c/20),Ze.y=e.y-(o.pageY+i.viewport.scrollTop)/(1+c/20)}),n.addEventListener("dragend",o=>{if(o.preventDefault(),!f.isDraggingBlocker)return;f.isDraggingBlocker=!1;let r=nt.x+Ze.x,a=nt.y+Ze.y;r===e.x||a===e.y||p.emit("editBlocker",{id:e.id,x:r,y:a,width:t.offsetWidth,height:t.offsetHeight})})}}function Zn(){i.polyBlockerHandles.innerHTML="";for(let e of me(i.polyBlockers))e.dispatchEvent(new Event("checkSelected"));for(let e of me(i.blockersDiv))e.dispatchEvent(new Event("checkSelected"))}function ei(){switch(d.blockerType){case 0:S.fillStyle=document.body.style.getPropertyValue("--antiBlocker-color"),S.fillRect(0,0,x.width,x.height),S.globalCompositeOperation="destination-out";for(let e of d.blockers)S.fillStyle="#FFFFFFFF",S.fillRect(e.x,e.y,e.width,e.height);S.globalCompositeOperation="source-over";break;case 1:S.fillStyle=document.body.style.getPropertyValue("--antiBlocker-color"),S.fillRect(0,0,x.width,x.height),S.globalCompositeOperation="destination-out";for(let e of d.polyBlockers)if(!e.inactive){S.beginPath(),S.fillStyle="#FFFFFFFF",S.moveTo(e.verts[0].x,e.verts[0].y);for(let t of e.verts)S.lineTo(t.x,t.y);S.fill()}S.globalCompositeOperation="source-over";break}}function xt(){if(re.strokeStyle=un,re.lineWidth=b,re.clearRect(0,0,x.width,x.height),re.beginPath(),!!Te){for(let e=-Math.round(x.width/s.x);e<=Math.round(x.width/s.x);e++)re.moveTo(e*s.x+D+.5,0),re.lineTo(e*s.x+D+.5,x.height);for(let e=-Math.round(x.height/s.y);e<=Math.round(x.height/s.y);e++)re.moveTo(0,e*s.y+C+.5),re.lineTo(x.width,e*s.y+C+.5);re.stroke()}}function fn(e,t){if(!R(e)){i.detailsIcon.src="public/blankToken.png",i.nameInput.value="DM only!",i.maxHpInput.value="",i.currentHpInput.value="",i.statusInput.value=e.status??"",i.initiativeInput.value="",i.groupIdInput.value="",i.acInput.value="",i.mentalDef.value="",i.physicalDef.value="",i.refDef.value="",i.fortDef.value="",i.willDef.value="",i.noteArea.value="",i.notesBoxTextArea.value="",kt(!1,!1);return}Xe=e.id,e.image?d.tokenList.includes(e.image)?i.detailsIcon.src=`public/tokens/${e.image}`:d.dmTokenList.includes(e.image)?i.detailsIcon.src=`public/dmTokens/${e.image}`:i.detailsIcon.src="public/blankToken.png":i.detailsIcon.src="public/blankToken.png",(document.activeElement!=i.nameInput||t)&&(i.nameInput.value=e.name??""),(document.activeElement!=i.noteArea||t)&&(i.noteArea.value=e.notes??""),(document.activeElement!=i.notesBoxTextArea||t)&&(i.notesBoxTextArea.value=e.notes??""),(document.activeElement!=i.initiativeInput||t)&&(i.initiativeInput.value=e.initiative?.toString()??""),(document.activeElement!=i.acInput||t)&&(i.acInput.value=e.ac?.toString()??""),(document.activeElement!=i.mentalDef||t)&&(i.mentalDef.value=e.mentalDef?.toString()??""),(document.activeElement!=i.physicalDef||t)&&(i.physicalDef.value=e.physicalDef?.toString()??""),(document.activeElement!=i.refDef||t)&&(i.refDef.value=e.refDef?.toString()??""),(document.activeElement!=i.fortDef||t)&&(i.fortDef.value=e.fortDef?.toString()??""),(document.activeElement!=i.willDef||t)&&(i.willDef.value=e.willDef?.toString()??""),(document.activeElement!=i.statusInput||t)&&(i.statusInput.value=e.status??""),(document.activeElement!=i.groupIdInput||t)&&(i.groupIdInput.value=e.group?.toString()??""),(document.activeElement!=i.currentHpInput&&document.activeElement!=i.maxHpInput||t)&&(i.currentHpInput.value=e.hp?.split("/")[0]??"",i.maxHpInput.value=e.hp?.split("/")[1]??""),kt(e.concentrating,e.hideTracker)}function ti(){i.tokensDiv.innerHTML="";for(let e of d.tokens)e.hidden&&(!y||f.playerMode)||hn(e)}function ke(e,t){t.parentElement?.removeChild(t),hn(e)}function hn(e){let t=document.createElement("div");t.style.top=`${e.y-s.y*e.size/2}px`,t.style.left=`${e.x-s.x*e.size/2}px`,t.style.width=`${e.size*s.x-b}px`,t.style.height=`${e.size*s.y-b}px`,t.style.position="absolute",t.style.zIndex=`${Math.floor(e.layer*10)+de}`,t.id=e.id;let n=document.createElement("img");n.style.zIndex=`${Math.floor(e.layer*10)+de}`,n.className="position-absolute w-100 h-100",e.image?d.tokenList.includes(e.image)?n.src=`public/tokens/${e.image}`:d.dmTokenList.includes(e.image)?n.src=`public/dmTokens/${e.image}`:n.src="public/blankToken.png":n.src="public/blankToken.png",n.title=e.status??"",t.appendChild(n),(f.isPlacingCone||f.isPlacingLine||f.isPlacingSquare||f.isDraggingBlocker||f.quickPolyBlockerMode)&&(t.style.pointerEvents="none"),t.addEventListener("mousemove",u=>{f.isPanning&&(i.viewport.scrollLeft=Y.x-(u.pageX/(1+c/20)-$.x),i.viewport.scrollTop=Y.y-(u.pageY/(1+c/20)-$.y))}),t.addEventListener("dragover",u=>{u.preventDefault()}),i.tokensDiv.appendChild(t),e.id===k&&(fn(e),P());let o;e.image||(o=document.createElement("div"),o.innerText=e.text,o.className="position-absolute top-50 start-50 translate-middle text-nowrap font-monospace text-dark",o.style.zIndex=`${Math.floor(e.layer*10)+de+1}`,t.appendChild(o),o.style.fontSize=`${Math.min(t.offsetWidth,t.offsetHeight)/e.text.length}`);let r;e.hidden&&(r=document.createElement("img"),r.src="images/hidden.png",r.className="position-absolute top-0 start-0",r.style.width=((e.size*s.x-b)/3).toString()+"px",r.style.height=((e.size*s.y-b)/3).toString()+"px",r.style.zIndex=(Math.floor(e.layer*10)+de+1).toString(),t.appendChild(r));let a;e.concentrating&&(!e.dm||y&&!f.playerMode)&&(a=document.createElement("img"),a.className="position-absolute bottom-0 start-0",a.src="images/literally_copyright.png",t.appendChild(a),a.style.width=((e.size*s.x-b)/3).toString()+"px",a.style.height=((e.size*s.y-b)/3).toString()+"px",a.style.zIndex=(Math.floor(e.layer*10)+de+1).toString()),t.addEventListener("contextmenu",u=>{if(fe(),he(),u.preventDefault(),!pe(u)&&(!y||f.playerMode))return;let m=[{text:"Draw Shape",hasSubMenu:!0,callback:()=>{xe(u,[{text:"Draw Circle",callback:()=>{let h=se("Please enter the desired radius in feet for your circle(s)");h===null||isNaN(h)||(ce.radius=(h+z/2*e.size)/z,p.emit("addDrawing",{shape:"circle",link:e.id,x:e.x,y:e.y,radius:ce.radius,trueColor:W,visible:y?confirm("Should the shape be visible?"):!0}),fe(),he())}},{text:"Draw Cone",callback:()=>{let h=se("Please enter the desired range in feet for your cone");h===null||isNaN(h)||(A.is90Deg=!1,A.x=e.x,A.y=e.y,A.range=h/z,A.linkId=e.id,f.isPlacingCone=!0,U())}},{text:"Draw 90\xB0 Cone",callback:()=>{let h=se("Please enter the desired range in feet for your cone");h===null||isNaN(h)||(A.is90Deg=!0,A.x=e.x,A.y=e.y,A.range=h/z,A.linkId=e.id,f.isPlacingCone=!0,U())}},{text:"Draw 5ft wide Line",callback:()=>{let h=se(`Please enter the desired range of the line in feet.
Then click where you want to aim.`);h===null||isNaN(h)||(ne.range=h/z,ne.x=e.x,ne.y=e.y,ne.linkId=e.id,f.isPlacing5ftLine=!0,U())}}])}}];(e.dm&&y||!e.dm)&&(m.unshift({text:"Delete token",hasSubMenu:!1,callback:()=>{p.emit("removeToken",{id:e.id}),e.id===k&&(i.initiativeInput.value="",i.nameInput.value="",i.acInput.value="",i.mentalDef.value="",i.physicalDef.value="",i.refDef.value="",i.fortDef.value="",i.willDef.value="",i.currentHpInput.value="",i.maxHpInput.value="",i.statusInput.value="",i.groupIdInput.value="",k="0-0-0-0-0",kt(!1,!1))}}),m.push({text:"Edit token",hasSubMenu:!0,callback:()=>{let g=[{text:"Change size",callback:()=>{let h=se("Please enter the new size of the token");if(!(h===null||isNaN(h))){if(h<=0||!y&&h>6){alert("The desired size is too large or invalid");return}p.emit("editToken",{id:e.id,size:h,layer:e.layer+e.size-h})}}},{text:"Change layer",callback:()=>{let h=wt("Please enter the new layer",e.layer);if(!(h===null||isNaN(h))){if(h<=0||h>499){alert("Layer must be > 0 and < 500 ");return}p.emit("editToken",{id:e.id,layer:h})}}}];e.text!=null&&g.push({text:"Edit text",callback:()=>{let h=prompt("Please enter the new text for the token:",e.text);h!==null&&p.emit("editToken",{id:e.id,text:h})}}),y&&g.push({text:"Toggle DM only",callback:()=>{p.emit("editToken",{id:e.id,dm:!e.dm})}}),xe(u,g)}}),m.push({text:"Change image",hasSubMenu:!0,callback:()=>{let g=[];g.push({text:"Text",callback:()=>{p.emit("editToken",{id:e.id,image:"",text:e.text?e.text:"Text"})}});for(let h of d.tokenList)g.push({text:h.substring(0,h.length-4),callback:()=>{p.emit("editToken",{id:e.id,image:h})}});if(y)for(let h of d.dmTokenList)g.push({text:h.substring(0,h.length-4),callback:()=>{p.emit("editToken",{id:e.id,image:h})}});xe(u,g)}})),y&&(m.push({text:e.hidden?"Reveal token":"Hide token",hasSubMenu:!1,callback:()=>{p.emit("setTokenHidden",{id:e.id,hidden:!e.hidden})}}),e.group!==void 0&&m.push({text:"Group options",hasSubMenu:!0,callback:()=>{xe(u,[{text:"Hide tokens",callback:()=>{for(let h of d.tokens)h.group==e.group&&p.emit("setTokenHidden",{id:h.id,hidden:!0})}},{text:"Reveal tokens",callback:()=>{for(let h of d.tokens)h.group==e.group&&p.emit("setTokenHidden",{id:h.id,hidden:!1})}},{text:"Hide trackers",callback:()=>{for(let h of d.tokens)h.group==e.group&&p.emit("editToken",{id:h.id,hideTracker:!0})}},{text:"Show trackers",callback:()=>{for(let h of d.tokens)h.group==e.group&&p.emit("editToken",{id:h.id,hideTracker:!1})}},{text:"Toggle DM only",callback:()=>{for(let h of d.tokens)h.group==e.group&&p.emit("editToken",{id:h.id,dm:!e.dm})}}])}})),O(u,m)}),Q(t,!0,u=>{(u.ctrlKey||u.metaKey)&&(f.controlPressed=!0),k=e.id,B="0-0-0-0-0",q="0-0-0-0-0",P(),i.detailsScreen.style.display="",n.style.opacity="0.7",a&&(a.style.opacity="0.7"),o&&(o.style.opacity="0.7"),r&&(r.style.opacity="0.7"),f.isPanning=!1},(u,m)=>{if(f.isPanning){f.controlPressed=!1,document.body.style.cursor="";return}let g={x:(u.pageX+i.viewport.scrollLeft)/(1+c/20),y:(u.pageY+i.viewport.scrollTop)/(1+c/20)},h={x:.5*s.x*e.size,y:.5*s.y*e.size};if(!De){let M=g.x-m.x+h.x,N=g.y-m.y+e.size*s.y/2;if(M===e.x&&N===e.y){f.controlPressed=!1,ke(e,t);return}if(!j(M,N)&&(!y||f.playerMode)){f.controlPressed=!1,ke(e,t);return}if(M<0||N<0||M>i.mapImage.offsetWidth||N>i.mapImage.offsetHeight){f.controlPressed=!1,ke(e,t);return}p.emit("moveToken",{id:e.id,x:M,y:N,bypassLink:!f.controlPressed}),f.controlPressed=!1;return}let w,v;if(e.size>=1?(w=Math.round((g.x-m.x-d.offsetX)/s.x)*s.x+h.x+D+b,v=Math.round((g.y-m.y-d.offsetY)/s.y)*s.y+h.y+C+b):(w=Math.round((g.x-d.offsetX-h.x)/(s.x*e.size))*(s.x*e.size)+h.x+D+b,v=Math.round((g.y-d.offsetY-h.y)/(s.y*e.size))*(s.y*e.size)+h.y+C+b),w===e.x&&v===e.y){f.controlPressed=!1,ke(e,t);return}if(!j(w,v)&&(!y||f.playerMode)){f.controlPressed=!1,ke(e,t);return}if(w<0||v<0||w>i.mapImage.offsetWidth||v>i.mapImage.offsetHeight){f.controlPressed=!1,ke(e,t);return}p.emit("moveToken",{id:e.id,x:w,y:v,bypassLink:!f.controlPressed}),f.controlPressed=!1},void 0,!0,u=>{u[0]=!f.isPanning}),t.addEventListener("dragcancel",()=>{ke(e,t)})}function ni(){for(let e of me(i.tokensDiv))e.style.outline=e.id===k?"0.15vw dashed aqua":""}var an=0;function mn(){an=i.initiativeTrackerDiv.scrollTop,i.initiativeTrackerDiv.innerHTML="";for(let e of d.tokens)if(R(e)&&!e.hideTracker){if(i.initSearch.value!=""){e.name&&(e.name.toLowerCase().includes(i.initSearch.value.toLowerCase())||!e.dm)&&ln(e);continue}ln(e)}i.initiativeTrackerDiv.scrollTop=an}var et=!1;function ln(e){if(e.initiative==null&&e.name==null&&e.ac==null&&e.hp==null)return;let t=document.createElement("div");t.id=e.id,t.className="d-flex gap-1 p-2 border border-dark-subtle rounded",t.draggable=!0,t.addEventListener("drop",r=>{et&&(r.dataTransfer?.getData("trackerId")!==e.id&&p.emit("switchTrackerPosition",{origin:r.dataTransfer?.getData("trackerId"),target:e.id}),et=!1)}),t.addEventListener("dblclick",()=>{me(i.tokensDiv).find(r=>r.id===e.id)?.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}),t.addEventListener("dragstart",r=>{r.dataTransfer?.setData("trackerId",e.id),et=!0}),t.addEventListener("dragend",()=>{et=!1}),t.addEventListener("dragover",r=>{r.preventDefault()}),t.addEventListener("contextmenu",r=>{r.preventDefault()}),t.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),i.detailsScreen.style.display="",k=e.id,B="0-0-0-0-0",q="0-0-0-0-0",P(),fn(e)}),t.insertAdjacentHTML("beforeend",`
    <div class="flex-shrink-1">
        <div class="d-flex align-items-center bg-body border rounded h-100">
            <span id="initIcon" class="p-2" style="cursor: pointer;"><i class="bi-clock"></i></span>
            <div class="border-start h-100"></div>
            <span class="p-2 text-center align-self-center"/>${e.initiative??""}</span>
        </div>
    </div>
    <div class="flex-grow-1">
        <div class="d-flex align-items-center bg-body border rounded h-100">
            <span class="p-2"><i class="bi-person-fill"></i></span>
            <div class="border-start h-100"></div>
            <span class="p-2 text-center text-break">${e.name??""}</span>
        </div>
    </div>
    <div class="flex-shrink-1">
        <div class="d-flex align-items-center bg-body border rounded h-100">
            <span class="p-2" id="heartIcon" style="cursor: pointer;"><i class="bi-heart-fill text-danger"></i></span>
            <div class="border-start h-100"></div>
            <span class="p-2 text-center">${e.hp?.split("/")[0]??""}</span>
            <div class="border-start h-100"></div>
            <span class="p-2 text-center">${e.hp?.split("/")[1]??""}</span>
        </div>
    </div>
    <div class="flex-shrink-1">
        <div class="d-flex align-items-center bg-body border rounded h-100">
            <span class="p-2"><i class="bi-shield-shaded"></i></span>
            <div class="border-start h-100"></div>
            <span class="p-2 text-center">${e.ac??""}</span>
        </div>
    </div>
    `),t.querySelector("#initIcon").addEventListener("click",r=>{r.stopPropagation(),p.emit("changeTurn",{id:d.currentTurn!==e.id?e.id:"0-0-0-0-0"})}),t.querySelector("#heartIcon").addEventListener("click",r=>{r.stopPropagation();let a=wt("Enter the damage to deal to this token: ");if(a===null||isNaN(a)||e.hp==null)return;let[u,m]=e.hp.split("/").map(g=>Number.parseFloat(g));p.emit("editToken",{id:e.id,hp:`${u-a}/${m}`})}),t.setAttribute("id",e.id),t.setAttribute("dm",e.dm.toString()),i.initiativeTrackerDiv.appendChild(t),P()}function ii(){k==="0-0-0-0-0"&&(i.detailsScreen.style.display="none");for(let e of me(i.initiativeTrackerDiv))e.tagName=="DIV"&&(e.id===k?(e.scrollIntoView(),e.style.background=e.getAttribute("dm")==="true"?"#a14b28":"#3b3b96"):e.style.background=e.getAttribute("dm")==="true"?"#614d45":"#424254",e.id===d.currentTurn?(e.classList.remove("border-dark-subtle"),e.classList.add("border-warning")):(e.classList.remove("border-warning"),e.classList.add("border-dark-subtle")))}function kt(e,t){i.concentratingInput.style.backgroundColor=e?getComputedStyle(document.body).getPropertyValue("--toggle-highlighted-color"):"",i.hideTrackerInput.children[0].src=t?"images/visibility_off-24px.svg":"images/visibility-24px.svg",i.hideTrackerInput.style.backgroundColor=t?getComputedStyle(document.body).getPropertyValue("--toggle-highlighted-color"):""}function gn(){i.sideMenuCollapse.style.display=Le?"":"none",i.sideMenuToggleIcon.classList.toggle("bi-arrow-bar-left",!Le),i.sideMenuToggleIcon.classList.toggle("bi-arrow-bar-right",Le),i.viewport.style.width=`calc(100% - ${i.sideMenu.offsetWidth}px)`,i.sideMenuToggle.style.right=Le?`${i.sideMenu.offsetWidth}px`:"0px"}i.sideMenuToggle.onclick=()=>{Le=!Le,gn()};i.sortTracker.onclick=()=>{p.emit("sortTracker")};i.initSearch.oninput=()=>{mn()};i.bulkTokenConfirm.onclick=()=>{f.isPlacingBulkOrigin=!0};i.toggleGrid.oncontextmenu=e=>{e.preventDefault(),i.startGridAligner.click()};i.toggleGrid.onclick=()=>{Te=!Te,xt(),X()};i.toggleSnap.onclick=()=>{De=!De,X()};i.quickPolyButton.onclick=()=>{y&&(f.quickPolyBlockerMode?(confirm("Add the new blocker?")&&we.length>2&&p.emit("addCustomPolyBlocker",{newPolyBlockerVerts:we}),f.quickPolyBlockerMode=!1,we=[],ot()):(f.quickPolyBlockerMode=!0,U())),X()};var it=!1;i.toggleSettings.onclick=()=>{it=!it,X()};i.mapOptionsMenuClose.onclick=()=>{it=!1,X()};Q(i.mapOptionsMenuBox,!0,void 0,void 0,void 0,void 0,void 0,i.mapOptionsMenuBody,!1);var cn=!1;i.colorPickerButton.onclick=()=>{cn=!cn,X()};i.toggleBlockerEditing.onclick=()=>{f.blockerEditMode=!f.blockerEditMode,U(),X()};i.redSlider.oninput=qe;i.greenSlider.oninput=qe;i.blueSlider.oninput=qe;i.opacitySlider.oninput=qe;i.redSlider.oninput=rt;i.greenSlider.onchange=rt;i.blueSlider.onchange=rt;i.opacitySlider.onchange=rt;function tt(e,t){t&&(e=Math.floor(e*255));let n=e.toString(16);return n.length==1?"0"+n:n}function oi(e,t,n,o){return`#${tt(e)}${tt(t)}${tt(n)}${tt(o,!0)}`}function ri(e){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16),a:parseInt(t[4],16)}:{r:0,g:0,b:0,a:0}}function si(e){W=e;let t=ri(e);i.redSlider.value=t.r.toString(),i.greenSlider.value=t.g.toString(),i.blueSlider.value=t.b.toString(),i.opacitySlider.value=(t.a/255).toString(),i.colorPickerButton.style.backgroundColor="rgba("+i.redSlider.value+","+i.greenSlider.value+","+i.blueSlider.value+","+i.opacitySlider.value+")"}function qe(){i.colorPickerButton.style.backgroundColor="rgba("+i.redSlider.value+","+i.greenSlider.value+","+i.blueSlider.value+","+i.opacitySlider.value+")"}function rt(){W=oi(parseInt(i.redSlider.value),parseInt(i.greenSlider.value),parseInt(i.blueSlider.value),parseFloat(i.opacitySlider.value)),i.colorPickerButton.style.backgroundColor="rgba("+i.redSlider.value+","+i.greenSlider.value+","+i.blueSlider.value+","+i.opacitySlider.value+")",vn("shapeColor",W)}Q(i.notesBox,!0,void 0,void 0,void 0,void 0,void 0,i.notesBoxTextArea,!1);i.hpIcon.onclick=()=>{L();let e=wt("Enter the damage to deal to this token: ");if(e===null||isNaN(e)||l.hp==null)return;let[t,n]=l.hp.split("/").map(o=>Number.parseFloat(o));p.emit("editToken",{id:l.id,hp:`${t-e}/${n}`})};var Xe,Be;i.noteArea.oninput=()=>{Be=d.tokens.find(e=>e.id===Xe)??Be,R(Be)&&p.emit("editToken",{id:Xe,notes:i.noteArea.value})};i.notesBoxTextArea.oninput=()=>{Be=d.tokens.find(e=>e.id===Xe)??Be,R(Be)&&p.emit("editToken",{id:Xe,notes:i.notesBoxTextArea.value})};i.initiativeInput.oninput=()=>{L();let e=Number.parseFloat(i.initiativeInput.value);R(l)&&p.emit("editToken",{id:k,initiative:isNaN(e)?null:e})};i.nameInput.oninput=()=>{L(),R(l)&&p.emit("editToken",{id:k,name:i.nameInput.value})};i.acInput.oninput=()=>{L();let e=Number.parseFloat(i.acInput.value);R(l)&&p.emit("editToken",{id:k,ac:isNaN(e)?null:e})};i.refDef.oninput=()=>{L();let e=Number.parseFloat(i.refDef.value);R(l)&&p.emit("editToken",{id:k,refDef:isNaN(e)?null:e})};i.fortDef.oninput=()=>{L();let e=Number.parseFloat(i.fortDef.value);R(l)&&p.emit("editToken",{id:k,fortDef:isNaN(e)?null:e})};i.willDef.oninput=()=>{L();let e=Number.parseFloat(i.willDef.value);R(l)&&p.emit("editToken",{id:k,willDef:isNaN(e)?null:e})};i.mentalDef.oninput=()=>{L();let e=Number.parseFloat(i.mentalDef.value);R(l)&&p.emit("editToken",{id:k,mentalDef:isNaN(e)?null:e})};i.physicalDef.oninput=()=>{L();let e=Number.parseFloat(i.physicalDef.value);R(l)&&p.emit("editToken",{id:k,physicalDef:isNaN(e)?null:e})};i.currentHpInput.oninput=()=>{L(),R(l)&&p.emit("editToken",{id:k,hp:`${Number(i.currentHpInput.value)}/${Number(i.maxHpInput.value)}`})};i.maxHpInput.oninput=()=>{L(),R(l)&&p.emit("editToken",{id:k,hp:`${Number(i.currentHpInput.value)}/${Number(i.maxHpInput.value)}`})};i.statusInput.oninput=()=>{L(),p.emit("editToken",{id:k,status:i.statusInput.value})};i.groupIdInput.oninput=()=>{let e=Number.parseInt(i.groupIdInput.value);L(),R(l)&&p.emit("editToken",{id:k,group:isNaN(e)?null:e})};i.hideTrackerInput.onclick=()=>{L(),p.emit("editToken",{id:k,hideTracker:!l.hideTracker})};i.concentratingInput.onclick=()=>{L(),p.emit("editToken",{id:k,concentrating:!l.concentrating})};i.clearTokens.onclick=()=>{confirm("Do you really want to remove all the tokens?")&&y&&p.emit("clearTokens")};i.clearDrawings.onclick=()=>{confirm("Do you really want to remove all the drawings?")&&y&&p.emit("clearDrawings")};i.clearBlockers.onclick=()=>{confirm("Do you really want to remove all the blockers?")&&y&&p.emit("clearBlockers")};i.blockerTypeSelect.onchange=()=>{confirm("Are you sure you want to switch blocker types?")&&y&&(f.quickPolyBlockerMode=!1,i.quickPolyButton.style.display=i.blockerTypeSelect.value==="1"?"":"none",p.emit("switchBlockerType",{type:Number.parseFloat(i.blockerTypeSelect.value)}))};i.invertBlockers.onclick=()=>{confirm("Do you really want to invert the blockers?")&&y&&p.emit("invertBlockers")};i.togglePlayerMode.onclick=()=>{f.playerMode=!f.playerMode,X(),i.shapeMap.style.zIndex=f.playerMode?"":"941",de=f.playerMode?0:500,U()};function P(){Zn(),Fn(),ni(),ii()}function pe(e){return d.antiBlockerOn?S.getImageData(Math.round((e.pageX+i.viewport.scrollLeft)/(1+c/20)),Math.round((e.pageY+i.viewport.scrollTop)/(1+c/20)),1,1).data[3]==0:!0}function j(e,t){return S.getImageData(e,t,1,1).data[3]==0}function L(){l=d.tokens.find(e=>e.id===k)??l}function R(e){if(e==null)return!1;if(e.dm!=null)return!(!y&&e.dm);if(e.image!=null)return y||d.tokenList.includes(e.image)}function ot(e){i.newPolyBlockerHandles.innerHTML="";for(let[t,n]of we.entries()){let o=document.createElement("div");o.style.position="absolute",o.style.left=n.x.toString(),o.style.top=n.y.toString();let r=document.createElement("div");r.className="newPolyBlockerHandle",r.style.left="-0.35vw",r.style.top="-0.35vw",r.title=(t+1).toString(),r.addEventListener("contextmenu",a=>{a.preventDefault(),O(a,[{text:"Remove vert",hasSubMenu:!1,callback:()=>{we.splice(t,1),ot()}}])}),Q(o,!0,void 0,a=>{(a.pageX+i.viewport.scrollLeft)/(1+c/20)!=n.x&&(a.pageY+i.viewport.scrollTop)/(1+c/20)!=n.y&&(n.x=(a.pageX+i.viewport.scrollLeft)/(1+c/20),n.y=(a.pageY+i.viewport.scrollTop)/(1+c/20),ot())}),r.addEventListener("dragover",a=>{a.preventDefault()}),o.appendChild(r),i.newPolyBlockerHandles.appendChild(o),t==we.length-1&&e&&r.dispatchEvent(new Event("mousedown"))}}window.addEventListener("mousedown",e=>{e.button===1&&(e.preventDefault(),(e.pageX+i.viewport.scrollLeft)/(1+c/20)>0&&(e.pageX+i.viewport.scrollLeft)/(1+c/20)<x.width&&(e.pageY+i.viewport.scrollTop)/(1+c/20)>0&&(e.pageY+i.viewport.scrollTop)/(1+c/20)<x.height&&p.emit("requestPing",{pingX:(e.pageX+i.viewport.scrollLeft)/(1+c/20),pingY:(e.pageY+i.viewport.scrollTop)/(1+c/20)}))});window.addEventListener("mouseup",e=>{if(e.button===0){if(document.body.style.cursor="",f.isPanning=!1,P(),(e.pageX+i.viewport.scrollLeft)/(1+c/20)<0||(e.pageX+i.viewport.scrollLeft)/(1+c/20)>x.width||(e.pageY+i.viewport.scrollTop)/(1+c/20)<0||(e.pageY+i.viewport.scrollTop)/(1+c/20)>x.height){f.isMovingShape=!1,f.isMovingCone=!1,f.isMoving5ftLine=!1;return}if(f.isMovingShape){f.isMovingShape=!1,(j((e.pageX+i.viewport.scrollLeft)/(1+c/20)+I.x,(e.pageY+i.viewport.scrollTop)/(1+c/20)+I.y)||y&&!f.playerMode)&&(p.emit("editDrawing",{id:_,x:(e.pageX+i.viewport.scrollLeft)/(1+c/20)+I.x,y:(e.pageY+i.viewport.scrollTop)/(1+c/20)+I.y,both:!0,moveShapeGroup:e.ctrlKey||e.metaKey}),_="0-0-0-0-0");return}if(f.isMovingCone){let t=d.drawings.find(o=>o.id===_);if(t===void 0)throw new Error(`Shape ${_} is missing!`);f.isMovingCone=!1;let n=t.angle+(Math.atan2((e.pageY+i.viewport.scrollTop)/(1+c/20)-I.y,(e.pageX+i.viewport.scrollLeft)/(1+c/20)-I.x)-Ye);n<0&&(n+=2*Math.PI),p.emit("editDrawing",{id:_,angle:n});return}if(f.isMoving5ftLine){let t=d.drawings.find(o=>o.id===_);if(t===void 0)throw new Error(`Shape ${_} is missing!`);f.isMoving5ftLine=!1;let n=t.angle+(Math.atan2((e.pageY+i.viewport.scrollTop)/(1+c/20)-I.y,(e.pageX+i.viewport.scrollLeft)/(1+c/20)-I.x)-Ye);n<0&&(n+=2*Math.PI),p.emit("editDrawing",{id:_,angle:n});return}}});document.body.addEventListener("keydown",e=>{if((e.code.includes("Numpad")&&document.activeElement?.tagName!="INPUT"&&document.activeElement?.tagName!="TEXTAREA"||e.code.includes("Numpad")&&isNaN(parseInt(e.key)))&&e.preventDefault(),e.ctrlKey||e.metaKey)switch(e.code){case"Digit0":c=0;break;case"Minus":c-=1,i.board.style.transform="scale("+(1+c/20).toString()+")",i.viewport.scrollLeft=i.viewport.scrollLeft/((1+c/20)/(1+(c-1)/20)),i.viewport.scrollTop=i.viewport.scrollTop/((1+c/20)/(1+(c-1)/20)),e.preventDefault();break;case"Equal":c+=1,i.board.style.transform="scale("+(1+c/20).toString()+")",i.viewport.scrollLeft=i.viewport.scrollLeft*((20+c)/(20+c-1)),i.viewport.scrollTop=i.viewport.scrollTop*((20+c)/(20+c-1)),e.preventDefault();break}});document.body.addEventListener("keyup",e=>{if(document.activeElement?.tagName!="INPUT"&&document.activeElement?.tagName!="TEXTAREA"||e.code.includes("Numpad")&&isNaN(parseInt(e.key))||e.altKey&&e.code=="KeyH"){e.preventDefault();let t,n;switch(e.code){case"Numpad8":L(),l.size>=1?(t=Math.round((l.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y-s.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y-s.y*l.size-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),n>0&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"Numpad7":L(),l.size>=1?(t=Math.round((l.x-s.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y-s.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x-s.x*l.size-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y-s.y*l.size-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),n>0&&t>0&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"Numpad9":L(),l.size>=1?(t=Math.round((l.x+s.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y-s.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x+s.x*l.size-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y-s.y*l.size-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),n>0&&t<x.width&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"Numpad4":L(),l.size>=1?(t=Math.round((l.x-s.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x-s.x*l.size-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),t>0&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"Numpad6":L(),l.size>=1?(t=Math.round((l.x+s.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x+s.x*l.size-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),t<x.width&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"Numpad2":L(),l.size>=1?(t=Math.round((l.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y+s.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y+s.y*l.size-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),n<x.height&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"Numpad1":L(),l.size>=1?(t=Math.round((l.x-s.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y+s.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x-s.x*l.size-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y+s.y*l.size-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),n<x.height&&t>0&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"Numpad3":L(),l.size>=1?(t=Math.round((l.x+s.x-d.offsetX-.5*s.x*l.size)/s.x)*s.x+.5*s.x*l.size+D+b,n=Math.round((l.y+s.y-d.offsetY-.5*s.y*l.size)/s.y)*s.y+.5*s.y*l.size+C+b):(t=Math.round((l.x+s.x*l.size-d.offsetX-.5*s.x*l.size)/(s.x*l.size))*(s.x*l.size)+.5*s.x*l.size+D+b,n=Math.round((l.y+s.y*l.size-d.offsetY-.5*s.y*l.size)/(s.y*l.size))*(s.y*l.size)+.5*s.y*l.size+C+b),n<x.height&&t<x.width&&(j(t,n)||y&&!f.playerMode)&&p.emit("moveToken",{id:k,x:t,y:n,bypassLink:!(e.ctrlKey||e.metaKey)});break;case"KeyC":i.colorPickerButton.click();break;case"KeyG":Te=!Te,X(),xt();break;case"KeyS":De=!De,X();break;case"KeyM":y&&i.togglePlayerMode.click();break;case"KeyB":y&&(f.blockerEditMode=!f.blockerEditMode,X(),U());break;case"KeyP":y&&d.blockerType==1&&i.quickPolyButton.click();break;case"KeyH":e.altKey&&i.hpIcon.click();break;case"Delete":if(y){if(k!=="0-0-0-0-0"){p.emit("removeToken",{id:k}),k="0-0-0-0-0";return}if(B!=="0-0-0-0-0"){p.emit(d.blockerType==1?"removePolyBlocker":"removeBlocker",{id:B}),B="0-0-0-0-0";return}}break}}});Q(i.bulkTokenBox,!0,void 0,void 0,void 0,void 0,void 0,i.bulkTokenBoxBody,!1);i.bulkTokenRollEach.oninput=()=>{i.bulkTokenRollEach.checked&&(i.bulkTokenRollOnce.checked=!1)};i.bulkTokenRollOnce.oninput=()=>{i.bulkTokenRollOnce.checked&&(i.bulkTokenRollEach.checked=!1)};i.bulkTokenInit.oninput=()=>{i.bulkTokenRollOnce.disabled=i.bulkTokenInit.value!=="",i.bulkTokenRollEach.disabled=i.bulkTokenInit.value!=="",i.bulkTokenInit.value!==""&&(i.bulkTokenRollEach.checked=!1,i.bulkTokenRollOnce.checked=!1)};function ai(e){let t={image:i.bulkTokenImageSelect.value,name:i.bulkTokenNameInput.value,amount:Number.parseInt(i.bulkTokenAmountInput.value),size:Number.parseFloat(i.bulkTokenSize.value),group:Number.parseFloat(i.bulkTokenGroup.value),hp:Number.parseFloat(i.bulkTokenHP.value),ac:Number.parseFloat(i.bulkTokenAC.value),fixedInit:Number.parseFloat(i.bulkTokenInit.value),dex:Number(i.bulkTokenDex.value),hideToken:i.bulkTokenHideToken.checked,hideTracker:i.bulkTokenHideTracker.checked,rollOnce:i.bulkTokenRollOnce.checked,rollEach:i.bulkTokenRollEach.checked};if(isNaN(t.amount)){alert("Missing amount of tokens!");return}if(isNaN(t.size)){alert("Missing token size!");return}let n={x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20)},o;t.rollOnce&&(o=Math.ceil(Math.random()*20)+t.dex),!t.rollEach&&!t.rollOnce&&!isNaN(t.fixedInit)&&(o=t.fixedInit);for(let r=0;r<t.amount;r++){t.rollEach&&(o=Math.ceil(Math.random()*20)+t.dex);let a={x:n.x+r%Math.ceil(Math.sqrt(t.amount))*t.size*s.x,y:n.y+Math.floor(r/Math.ceil(Math.sqrt(t.amount)))*t.size*s.y};p.emit("createToken",{text:t.name!==""?`${t.name} ${r+1}`:(r+1).toString(),image:t.image!=="number"?t.image:void 0,x:a.x,y:a.y,size:t.size,layer:50-t.size,dm:!0,name:t.name?`${t.name} ${r+1}`:(r+1).toString(),initiative:t.rollEach||t.rollOnce||t.fixedInit!==void 0?o:void 0,hidden:t.hideToken,group:isNaN(t.group)?void 0:t.group,hideTracker:t.hideTracker,hp:isNaN(t.hp)?void 0:`${t.hp}/${t.hp}`,ac:isNaN(t.ac)?void 0:t.ac})}f.isPlacingBulkOrigin=!1}i.mapImage.addEventListener("mousedown",e=>{if(e.button===0){if(k="0-0-0-0-0",B="0-0-0-0-0",q="0-0-0-0-0",P(),i.detailsScreen.style.display="none",f.isPlacingBulkOrigin&&ai(e),f.quickPolyBlockerMode){we.push({x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20)}),ot(!0);return}if(f.isPlacingSquare){if(f.isPlacingSquare=!1,K.width=(e.pageX+i.viewport.scrollLeft)/(1+c/20)-K.x,K.height=(e.pageY+i.viewport.scrollTop)/(1+c/20)-K.y,Math.abs(K.width)>x.width||Math.abs(K.height)>x.height){alert("That square was too large or too small");return}if(!pe(e)&&(!y||f.playerMode))return;p.emit("addDrawing",{shape:"square",x:K.x,y:K.y,width:K.width,height:K.height,trueColor:W,visible:y?confirm("Should the shape be visible?"):!0});return}if(f.isPlacingBlocker){if(f.isPlacingBlocker=!1,!y)return;te.width=(e.pageX+i.viewport.scrollLeft)/(1+c/20)-te.x,te.height=(e.pageY+i.viewport.scrollTop)/(1+c/20)-te.y,p.emit("addBlocker",{x:te.x,y:te.y,width:te.width,height:te.height});return}if(f.isPlacingLine){if(ue.destX=(e.pageX+i.viewport.scrollLeft)/(1+c/20),ue.destY=(e.pageY+i.viewport.scrollTop)/(1+c/20),y&&!f.playerMode||pe(e)){let t=!0;y&&(t=confirm("Should the shape be visible?")),p.emit("addDrawing",{shape:"vertexLine",verts:[{x:ue.x,y:ue.y},{x:ue.destX,y:ue.destY}],trueColor:W,visible:t})}f.isPlacingLine=!1;return}if(f.isPlacing5ftLine){let t=(e.pageX+i.viewport.scrollLeft)/(1+c/20),n=(e.pageY+i.viewport.scrollTop)/(1+c/20),o=Math.atan2(n-ne.y,t-ne.x);if(o<0&&(o+=2*Math.PI),y&&!f.playerMode||pe(e)){let r=!0;y&&(r=confirm("Should the shape be visible?")),p.emit("addDrawing",{shape:"5ftLine",x:ne.x,y:ne.y,angle:o,trueColor:W,link:ne.linkId,range:ne.range,visible:r})}f.isPlacing5ftLine=!1;return}if(f.isPlacingCone){let t=(e.pageX+i.viewport.scrollLeft)/(1+c/20),n=(e.pageY+i.viewport.scrollTop)/(1+c/20),o=Math.atan2(n-A.y,t-A.x);o<0&&(o+=2*Math.PI),(y&&!f.playerMode||pe(e))&&p.emit("addDrawing",{shape:"cone",link:A.linkId,x:A.x,y:A.y,angle:o,range:A.range,trueColor:W,visible:y?confirm("Should the shape be visible?"):!0,is90Deg:A.is90Deg}),f.isPlacingCone=!1;return}f.isPanning=!0,$.x=e.pageX,$.y=e.pageY,Y.x=i.viewport.scrollLeft,Y.y=i.viewport.scrollTop,document.body.style.cursor="grabbing"}});window.addEventListener("mousemove",e=>{f.isPanning&&(i.viewport.scrollLeft=Y.x+$.x-e.pageX,i.viewport.scrollTop=Y.y+$.y-e.pageY)});i.mapImage.addEventListener("dragstart",e=>{e.preventDefault(),e.stopPropagation()});i.mapImage.addEventListener("contextmenu",e=>{e.preventDefault(),f.isPanning||(pe(e)||y&&!f.playerMode?li(e):(fe(),he()))});function li(e){let t=[{text:"Place Token",hasSubMenu:!0,callback:()=>{let o=new Array,r=d.tokenList,a=d.dmTokenList;o.push({text:"Text token",callback:()=>{let u=prompt("Enter the text to display on the text token:")??"",m=Number.parseFloat(prompt("Please enter the size of the token")??"");if(isNaN(m)){alert("That wasn't a valid size!");return}if(y&&(m>49||m<=0)){alert("The desired size is too large or invalid");return}if(!y&&(m>6||m<=0)){alert("That token size isn't allowed for players");return}console.log(`Placing text token '${u}' with size ${m} at ${(e.pageX+i.viewport.scrollLeft)/(1+c/20)}:${(e.pageY+i.viewport.scrollTop)/(1+c/20)}`),p.emit("createToken",{text:u,x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20),size:m,status:"",layer:50-m,dm:y?confirm("Make this a DM token?"):!1})}});for(let u of r)o.push({text:u.substring(0,u.length-4),callback:()=>{let m=Number.parseFloat(prompt("Please enter the size of the token")??"");if(isNaN(m)){alert("That wasn't a valid size!");return}if(y&&(m>49||m<=0)){alert("The desired size is too large or invalid");return}if(!y&&(m>6||m<=0)){alert("That token size isn't allowed for players");return}console.log(`Placing ${u} with size ${m} at ${(e.pageX+i.viewport.scrollLeft)/(1+c/20)}:${(e.pageY+i.viewport.scrollTop)/(1+c/20)}`),p.emit("createToken",{x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20),image:u,size:m,status:"",layer:50-m,dm:!1,text:""})}});if(y)for(let u of a)o.push({text:u.substring(0,u.length-4),callback:()=>{let m=Number.parseFloat(prompt("Please enter the size of the token")??"");if(isNaN(m)){alert("That wasn't a valid size!");return}if(y&&(m>49||m<=0)){alert("The desired size is too large or invalid");return}if(!y&&(m>6||m<=0)){alert("That token size isn't allowed for players");return}console.log(`Placing ${u} with size ${m} at ${(e.pageX+i.viewport.scrollLeft)/(1+c/20)}:${(e.pageY+i.viewport.scrollTop)/(1+c/20)}`),p.emit("createToken",{x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20),image:u,size:m,status:"",layer:50-m,dm:!0,text:""})}});xe(e,o)}},{text:"Draw Shape",hasSubMenu:!0,callback:()=>{xe(e,[{text:"Draw Circle",callback:()=>{let r=se("Please enter the desired radius in feet for your circle(s)");r===null||isNaN(r)||(ce.radius=r/z,ce.x=(e.pageX+i.viewport.scrollLeft)/(1+c/20),ce.y=(e.pageY+i.viewport.scrollTop)/(1+c/20),p.emit("addDrawing",{shape:"circle",x:ce.x,y:ce.y,radius:ce.radius,trueColor:W,visible:y?confirm("Should the shape be visible?"):!0}))}},{text:"Draw Square",callback:()=>{K.x=(e.pageX+i.viewport.scrollLeft)/(1+c/20),K.y=(e.pageY+i.viewport.scrollTop)/(1+c/20),f.isPlacingSquare=!0,U()}},{text:"Draw Line",callback:()=>{ue.x=(e.pageX+i.viewport.scrollLeft)/(1+c/20),ue.y=(e.pageY+i.viewport.scrollTop)/(1+c/20),f.isPlacingLine=!0,U()}}])}}],n=[{text:"Place hidden Token",hasSubMenu:!0,callback:()=>{let o=[{text:"Text token",callback:()=>{let r=prompt("Enter the text to display on the text token:")??"",a=Number.parseFloat(prompt("Please enter the size of the token")??"");if(isNaN(a)){alert("That wasn't a valid size!");return}if(y&&(a>49||a<=0)){alert("The desired size is too large or invalid");return}console.log(`Placing hidden text token ${r} with size ${a} at ${(e.pageX+i.viewport.scrollLeft)/(1+c/20)}:${(e.pageY+i.viewport.scrollTop)/(1+c/20)}`),p.emit("createToken",{text:r,x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20),size:a,status:"",layer:50-a,dm:confirm("Make this a DM token?"),hidden:!0})}}];for(let r of d.tokenList)o.push({text:r.substring(0,r.length-4),callback:()=>{let a=se("Please enter the size of the token");if(a===null||isNaN(a)){alert("That wasn't a valid size!");return}if(a>49&&a<=0){alert("The desired size is too large or invalid!");return}console.log("Placing hidden "+r+" with size "+a+" at "+((e.pageX+i.viewport.scrollLeft)/(1+c/20)).toString()+":"+((e.pageY+i.viewport.scrollTop)/(1+c/20)).toString()),p.emit("createToken",{x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20),image:r,size:a,status:"",hidden:!0,layer:50-a,dm:!0,text:""})}});for(let r of d.dmTokenList)o.push({text:r.substring(0,r.length-4),callback:()=>{let a=se("Please enter the size of the token");if(a===null||isNaN(a)){alert("That wasn't a valid size!");return}if(a>49&&a<=0){alert("The desired size is too large or invalid!");return}console.log("Placing hidden "+r+" with size "+a+" at "+((e.pageX+i.viewport.scrollLeft)/(1+c/20)).toString()+":"+((e.pageY+i.viewport.scrollTop)/(1+c/20)).toString()),p.emit("createToken",{x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20),image:r,size:a,status:"",hidden:!0,layer:50-a,dm:!0,text:""})}});xe(e,o)}}];if(k!=="0-0-0-0-0"&&t.push({text:"Measure Distance",hasSubMenu:!1,callback:()=>{L();let o={x:Math.floor(((e.pageX+i.viewport.scrollLeft)/(1+c/20)-d.offsetX)/s.x),y:Math.floor(((e.pageY+i.viewport.scrollTop)/(1+c/20)-d.offsetY)/s.y)},r={x:(l.x-d.offsetX)/s.x,y:(l.y-d.offsetY)/s.y},a=l.size/2-.5,u={x:Math.floor(Math.min(Math.max(o.x,r.x-a),r.x+a)),y:Math.floor(Math.min(Math.max(o.y,r.y-a),r.y+a))},m={x:Math.abs(o.x-u.x),y:Math.abs(o.y-u.y)};switch(d.diagonalMovement){case"5-10":alert(`Distance: ${Math.max(m.x,m.y)+Math.floor(Math.min(m.x,m.y)/2)}`);break;case"taxi":alert(`Distance: ${m.x+m.y}`);break}}}),f.gridAlignMode){let o={x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20)};t.unshift({text:"Horizontal Aligner",hasSubMenu:!1,callback:()=>{let r=document.createElement("div");r.className="position-absolute translate-middle-y start-0",r.style.top=`${o.y}px`,r.style.zIndex="9998",r.style.height=`${b}px`,r.style.width=`${x.width}px`,r.style.backgroundColor="magenta";let a=document.createElement("div");a.style.height=`${b*10}px`,a.style.width=`${b*20}px`,a.className="position-absolute translate-middle-y border rounded",a.style.backgroundColor="violet",a.style.zIndex="9999",a.addEventListener("contextmenu",u=>{u.preventDefault(),O(u,[{text:"Delete",hasSubMenu:!1,callback:()=>{i.hAlignHandles.removeChild(r)}}])}),r.appendChild(a),i.hAlignHandles.appendChild(r),Q(r,!0)}},{text:"Vertical Aligner",hasSubMenu:!1,callback:()=>{let r=document.createElement("div");r.className="position-absolute translate-middle-x top-0",r.style.left=`${o.x}px`,r.style.zIndex="9998",r.style.width=`${b}px`,r.style.height=`${x.height}px`,r.style.backgroundColor="magenta";let a=document.createElement("div");a.style.height=`${b*20}px`,a.style.width=`${b*10}px`,a.className="position-absolute translate-middle-x border rounded",a.style.backgroundColor="violet",a.style.zIndex="9999",a.addEventListener("contextmenu",u=>{u.preventDefault(),O(u,[{text:"Delete",hasSubMenu:!1,callback:()=>{i.vAlignHandles.removeChild(r)}}])}),r.appendChild(a),i.vAlignHandles.appendChild(r),Q(r,!0)}})}if(d.blockerType===0&&n.push({text:d.antiBlockerOn?"Place Anti Blocker":"Place Blocker",hasSubMenu:!1,callback:()=>{te.x=(e.pageX+i.viewport.scrollLeft)/(1+c/20),te.y=(e.pageY+i.viewport.scrollTop)/(1+c/20),f.isPlacingBlocker=!0,U()}}),d.blockerType===1&&n.push({text:d.antiBlockerOn?"Create Anti Blocker":"Create Blocker",hasSubMenu:!1,callback:()=>{p.emit("addPolyBlocker",{x:(e.pageX+i.viewport.scrollLeft)/(1+c/20),y:(e.pageY+i.viewport.scrollTop)/(1+c/20),offset:s})}}),y)for(let o of n)t.push(o);O(e,t)}window.onclick=function(e){if(e.target===null)return;let t=yn(e.target),n=!0;for(let o of t)try{o.classList.contains("custom-menu")&&(n=!1)}catch{o.className.includes("custom-menu")&&(n=!1)}n&&(fe(),he())};i.mapImage.addEventListener("dragover",e=>{e.preventDefault()});i.mapImage.addEventListener("dragend",e=>{e.preventDefault()});window.ondrop=e=>{e.preventDefault(),f.isDraggingBlocker&&(nt.x=(e.pageX+i.viewport.scrollLeft)/(1+c/20),nt.y=(e.pageY+i.viewport.scrollTop)/(1+c/20))};function O(e,t){if(fe(),he(),i.customMenu.innerHTML="",t.length>0){let n=t.length*4;n>28?(n=28,i.customMenu.style.overflowY="scroll"):i.customMenu.style.overflowY="hidden",i.customMenu.style.display="block";let o=(e.pageX+i.viewport.scrollLeft)/(1+c/20),r=(e.pageY+i.viewport.scrollTop)/(1+c/20);i.customMenu.style.transform="scale("+1/(1+c/20)+")",i.customMenu.style.transformOrigin="top left",i.customMenu.style.top=r+"px",i.customMenu.style.left=o+"px",i.customMenu.style.height=n+"vh";for(let a of t){let u=document.createElement("li");u.innerText=a.text,u.style.userSelect="none",u.className="custom-menu-element",u.onclick=()=>{a.callback(),a.hasSubMenu!=!0&&(fe(),he())},i.customMenu.appendChild(u)}e.pageX+i.customMenu.offsetWidth>=window.innerWidth+window.pageXOffset-i.sideMenu.offsetWidth&&(i.customMenu.style.left=((window.innerWidth+i.viewport.scrollLeft-i.customMenu.offsetWidth-i.sideMenu.offsetWidth-5)/(1+c/20)).toString()+"px"),e.pageY+i.customMenu.offsetHeight>window.innerHeight+window.pageYOffset&&(i.customMenu.style.top=((window.innerHeight+i.viewport.scrollTop-i.customMenu.offsetHeight-4)/(1+c/20)).toString()+"px")}}function fe(){i.customMenu.style.display="none"}function xe(e,t){if(i.customSubMenu.innerHTML="",t.length>0){let n=t.length*4;n>60?(n=60,i.customSubMenu.style.overflowY="scroll"):i.customSubMenu.style.overflowY="hidden",i.customSubMenu.style.display="block",i.customSubMenu.style.transform="scale("+1/(1+c/20)+")",i.customSubMenu.style.transformOrigin="top left",i.customSubMenu.style.height=n+"vh",i.customSubMenu.style.top=((e.pageY+i.viewport.scrollTop)/(1+c/20)).toString()+"px",i.customSubMenu.style.left=(i.customMenu.offsetLeft+i.customSubMenu.offsetWidth/(1+c/20)+1/(1+c/20)).toString()+"px";for(let o of t){let r=document.createElement("li");r.innerText=o.text,r.style.userSelect="none",r.className="custom-menu-element",r.onclick=()=>{o.callback(),fe(),he()},i.customSubMenu.appendChild(r)}e.pageY+i.customSubMenu.offsetHeight>window.innerHeight+window.pageYOffset&&(i.customSubMenu.style.top=((window.innerHeight+i.viewport.scrollTop-i.customSubMenu.offsetHeight-4)/(1+c/20)).toString()+"px"),e.pageX+i.customMenu.offsetWidth+i.customSubMenu.offsetWidth>=window.innerWidth+window.pageXOffset-i.sideMenu.offsetWidth&&(i.customSubMenu.style.left=(i.customMenu.offsetLeft-i.customSubMenu.offsetWidth/(1+c/20)-1/(1+c/20)).toString()+"px")}}function he(){i.customSubMenu.style.display="none"}function se(e,t){let n=prompt(e,t?.toString());return n===null?(console.log("Cancelled input!"),null):n===""?(console.log("Received invalid number!"),NaN):Number.parseFloat(n)}function wt(e,t){let n=prompt(e,t?.toString());return n===null?(console.log("Cancelled input!"),null):n===""?(console.log("Received invalid int!"),NaN):parseInt(n)}function me(e){let t=new Array;for(let n of e.children)t.push(n);return t}function yn(e){let t=new Array,n=e;do{if(t.push(n),n.parentElement===null)return t;n=n.parentElement}while(n!==document.body);return t}function vn(e,t){let n=new Date;n.setTime(n.getTime()+365*24*60*60*1e3);let o="expires="+n.toUTCString();document.cookie=e+"="+t+";"+o+";path=/"}function bn(e){for(let t of document.cookie.split(";"))if(t=t.trim(),t.startsWith(e))return t.substring(e.length+1,t.length);return""}function X(){i.toggleGrid.style.backgroundColor=f.gridAlignMode?Te?"#ffa5ff":"#00a5ff":Te?"#ffa500":"",i.toggleSnap.style.backgroundColor=De?"#ffa500":"",qe(),y&&(i.togglePlayerMode.style.backgroundColor=f.playerMode?"#ffa500":"",i.toggleSettings.style.backgroundColor=it?"#ffa500":"",i.toggleBlockerEditing.style.backgroundColor=f.blockerEditMode?"#ffa500":"",i.quickPolyButton.style.backgroundColor=f.quickPolyBlockerMode?"#ffa500":"")}})();
//# sourceMappingURL=map.js.map
